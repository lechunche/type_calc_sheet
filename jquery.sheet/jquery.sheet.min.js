/**
 * @project jQuery.sheet() The Ajax Spreadsheet - http://code.google.com/p/jquerysheet/
 * @author RobertLeePlummerJr@gmail.com
 * $Id: jquery.sheet.min.js 684 2013-02-04 21:04:11Z robertleeplummerjr@gmail.com $
 * Licensed under MIT
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 */
var jQuery=jQuery||{fn:{extend:function(){}}};jQuery.fn.extend({sheet:function(a){a=a||{};jQuery(this).each(function(){var f=jQuery(this),h={editable:true,editableNames:true,barMenus:true,freezableCells:true,allowToggleState:true,menuLeft:null,newColumnWidth:120,title:null,menuRight:null,calcOff:false,log:false,lockFormulas:false,parent:f,colMargin:18,boxModelCorrection:2,formulaFunctions:{},formulaVariables:{},cellSelectModel:"excel",autoAddCells:true,resizableCells:true,resizableSheet:true,autoFiller:true,minSize:{rows:1,cols:1},alertFormulaErrors:false,error:function(j){return j.error},encode:function(k){switch(typeof k){case"object":return k;case"number":return Globalize.format(k,"n")}if(!k){return k||""}if(!k.replace){return k||""}var j=$.trim(k)*1;if(!isNaN(j)){return Globalize.format(j,"n")}return k.replace(/&/gi,"&amp;").replace(/>/gi,"&gt;").replace(/</gi,"&lt;").replace(/\n/g,"\n<br>").replace(/\t/g,"&nbsp;&nbsp;").replace(/ /g,"&nbsp;")},frozenAt:[],contextmenuTop:{"Toggle freeze columns to here":function(k){var j=k.getTdLocation(k.obj.cellActive()).col;k.frozenAt().col=(k.frozenAt().col==j?0:j)},"Insert column after":function(j){j.controlFactory.addColumn(j.colLast);return false},"Insert column before":function(j){j.controlFactory.addColumn(j.colLast,true);return false},"Add column to end":function(j){j.controlFactory.addColumn();return false},"Delete this column":function(j){j.deleteColumn();return false},"Hide column":function(j){j.toggleHide.column();return false}},contextmenuLeft:{"Toggle freeze rows to here":function(j){var k=j.getTdLocation(j.obj.cellActive()).row;j.frozenAt().row=(j.frozenAt().row==k?0:k)},"Insert row after":function(j){j.controlFactory.addRow(j.rowLast);return false},"Insert row before":function(j){j.controlFactory.addRow(j.rowLast,true);return false},"Add row to end":function(j){j.controlFactory.addRow();return false},"Delete this row":function(j){j.deleteRow();return false},"Hide row":function(j){j.toggleHide.row();return false}},contextmenuCell:{Copy:false,Cut:false,"Insert column after":function(j){j.controlFactory.addColumn(j.colLast);return false},"Insert column before":function(j){j.controlFactory.addColumn(j.colLast,true);return false},"Add column to end":function(j){j.controlFactory.addColumn();return false},"Delete this column":function(j){j.deleteColumn();return false},line1:"line","Insert row after":function(j){j.controlFactory.addRow();return false},"Insert row before":function(j){j.controlFactory.addRow(j.rowLast,true);return false},"Add row to end":function(j){j.controlFactory.addRow();return false},"Delete this row":function(j){j.deleteRow();return false},line2:"line","Add spreadsheet":function(j){j.addSheet("5x10")},"Delete spreadsheet":function(j){j.deleteSheet()}},hiddenRows:[],hiddenColumns:[]},d=jQuery.sheet.events;var g=f.getSheet();if(g){var c=f.children().detach();g.kill();f.html(c);for(var b in d){if(a[d[b]]){f.unbind(d[b])}}}for(var b in d){if(a[d[b]]){f.bind(d[b],a[d[b]])}}if(!jQuery.sheet.instance.length){jQuery.sheet.instance=$([])}g=jQuery.sheet.createInstance(jQuery,jQuery.extend(h,a),jQuery.sheet.instance.length);jQuery.sheet.instance=jQuery.sheet.instance.add(g)});return this},disableSelectionSpecial:function(){this.each(function(){this.onselectstart=function(){return false};this.unselectable="on";jQuery(this).css("-moz-user-select","none")});return this},getSheet:function(){return jQuery(this).data("sheetInstance")},getCellValue:function(f,a,b){var c=jQuery(this).getSheet();b=(b?b:0);try{return c.updateCellValue(b,f,a)}catch(d){return""}},setCellValue:function(d,g,a,b){var c=jQuery(this).getSheet();b=(b?b:0);try{c.spreadsheets[b][g][a].value=d;return c.updateCellValue(b,g,a)}catch(f){}},setCellFormula:function(g,f,a,b){var c=jQuery(this).getSheet();b=(b?b:0);try{c.spreadsheets[b][f][a].formula=g;return c.updateCellValue(b,f,a)}catch(d){}},setCellHtml:function(c,g,a,b){var d=jQuery(this).getSheet();b=(b?b:0);try{d.spreadsheets[b][g][a].html=[c];return d.updateCellValue(b,g,a)}catch(f){}},isSheetFullScreen:function(){var a=$(this).getSheet();if(a.obj.fullScreen().is(":visible")){return true}else{return false}},serializeCellInputs:function(c){var b=$(this).getSheet(),a=b.obj.sheets().find(":input");if(c){return a.serializeArray()}else{return a.serialize()}}});jQuery.sheet={instance:[],dependencies:{coreCss:{css:"jquery.sheet.css"},globalize:{script:"plugins/globalize.js"},globalizeCultures:{script:"plugins/globalize.cultures.js"},formulaParser:{script:"parser/formula/formula.js"},tsvParser:{script:"parser/tsv/tsv.js"},mousewheel:{script:"plugins/jquery.mousewheel.min.js"},nearest:{script:"plugins/jquery.nearest.min.js"}},optional:{raphael:{script:"plugins/raphael-min.js"},gRaphael:{script:"plugins/g.raphael-min.js"},colorPicker:{css:"plugins/jquery.colorPicker.css"},colorPicker:{script:"plugins/jquery.colorPicker.min.js"},elastic:{script:"plugins/jquery.elastic.min.js"},advancedfn:{script:"plugins/jquery.sheet.advancedfn.js"},financefn:{script:"plugins/jquery.sheet.financefn.js"},dts:{script:"plugins/jquery.sheet.dts.js"},zeroclipboard:{script:"plugins/ZeroClipboard.js"}},events:["sheetAddRow","sheetAddColumn","sheetSwitch","sheetRename","sheetTabSortStart","sheetTabSortUpdate","sheetCellEdit","sheetCellEdited","sheetCalculation","sheetAdd","sheetDelete","sheetDeleteRow","sheetDeleteColumn","sheetOpen","sheetAllOpened","sheetSave","sheetFullScreen","sheetFormulaKeydown"],preLoad:function(b){var a=function(){if(this.script){document.write('<script src="'+b+this.script+'"><\/script>')}else{if(this.css){document.write('<link rel="stylesheet" type="text/css" href="'+b+this.css+'"></link>')}}};$.each(this.dependencies,function(){a.apply(this)});$.each(this.optional,function(){a.apply(this)})},repeat:function(b,a){return new Array(a).join(b)},nthCss:function(k,g,h,d,b,c){var a=[];c=c||"{display: none;}";if(h.styleSheet){for(var f in d){var j;if(d[f]>b){a.push(g+" "+k+":first-child"+jQuery.sheet.repeat("+"+k,d[f]))}}if(a.length){return a.join(",")+c}}else{for(var f in d){if(d[f]>b){a.push(g+" "+k+":nth-child("+d[f]+")")}}if(a.length){return a.join(",")+c}}return""},createInstance:function(d,k,g){var f={version:"3.0",i:0,I:g,sheetCount:0,scrolledArea:[],spreadsheets:[],controls:{autoFiller:[],bar:{helper:[],corner:[],x:{controls:[],handleFreeze:[],menu:[],menuParent:[],parent:[],scroll:[],td:[],tds:function(){var m=d([]);for(var l in this.td[f.i]){m=m.add(this.td[f.i][l])}return m}},y:{controls:[],handleFreeze:[],menu:[],parent:[],scroll:[],td:[],tds:function(){var m=d([]);for(var l in this.td[f.i]){m=m.add(this.td[f.i][l])}return m}}},barMenuLeft:[],barMenuTop:[],barLeft:[],barTop:[],barTopParent:[],chart:[],cellMenu:[],enclosure:[],enclosures:null,formula:null,fullScreen:[],header:null,inPlaceEdit:[],label:null,menuLeft:[],menuRight:[],pane:[],panes:null,scroll:[],scrolls:null,sheet:[],sheets:null,tab:[],tabContainer:null,tabs:null,title:null,toggleHide:{x:[],y:[]},ui:null},obj:{autoFiller:function(){return f.controls.autoFiller[f.i]||d([])},barCorner:function(){return f.controls.bar.corner[f.i]||d([])},barHelper:function(){return f.controls.bar.helper[f.i]||(f.controls.bar.helper[f.i]=d([]))},barLeft:function(l){return(f.controls.bar.y.td[f.i]&&f.controls.bar.y.td[f.i][l]?f.controls.bar.y.td[f.i][l]:d([]))},barLeftControls:function(){return f.controls.bar.y.controls[f.i]||d([])},barLefts:function(){return f.controls.bar.y.tds()},barHandleFreezeLeft:function(){return f.controls.bar.y.handleFreeze[f.i]||d([])},barMenuLeft:function(){return f.controls.bar.y.menu[f.i]||d([])},barTop:function(l){return(f.controls.bar.x.td[f.i]&&f.controls.bar.x.td[f.i][l]?f.controls.bar.x.td[f.i][l]:d([]))},barTopControls:function(){return f.controls.bar.x.controls[f.i]||d([])},barTops:function(){return f.controls.bar.x.tds()},barTopParent:function(){return f.controls.bar.x.parent[f.i]||d([])},barHandleFreezeTop:function(){return f.controls.bar.x.handleFreeze[f.i]||d([])},barMenuParentTop:function(){return f.controls.bar.x.menuParent[f.i]||d([])},barMenuTop:function(){return f.controls.bar.x.menu[f.i]||d([])},cellActive:function(){return f.cellLast.td||d([])},cellMenu:function(){return f.controls.cellMenu[f.i]||d([])},cellHighlighted:function(){return f.highlightedLast.td||d([])},chart:function(){return f.controls.chart[f.i]||d([])},enclosure:function(){return f.controls.enclosure[f.i]||d([])},enclosures:function(){return f.controls.enclosures||d([])},formula:function(){return f.controls.formula||d([])},fullScreen:function(){return f.controls.fullScreen[f.i]||d([])},header:function(){return f.controls.header||d([])},menuRight:function(){return f.controls.menuRight[f.i]||d([])},inPlaceEdit:function(){return f.controls.inPlaceEdit[f.i]||d([])},label:function(){return f.controls.label||d([])},menuLeft:function(){return f.controls.menuLeft[f.i]||d([])},pane:function(){return f.controls.pane[f.i]||d([])},panes:function(){return f.controls.panes||d([])},parent:function(){return k.parent},scrollStyleX:function(){return f.controls.bar.x.scroll[f.i]||d([])},scrollStyleY:function(){return f.controls.bar.y.scroll[f.i]||d([])},scroll:function(){return f.controls.scroll[f.i]||d([])},scrolls:function(){return f.controls.scrolls||d([])},sheet:function(){return f.controls.sheet[f.i]||d([])},sheets:function(){return f.controls.sheets||d([])},tab:function(){return f.controls.tab[f.i]||d([])},tabs:function(){return f.controls.tabs||d([])},tabContainer:function(){return f.controls.tabContainer||d([])},toggleHideStyleX:function(){return f.controls.toggleHide.x[f.i]||d([])},toggleHideStyleY:function(){return f.controls.toggleHide.y[f.i]||d([])},title:function(){return f.controls.title||d([])},ui:function(){return f.controls.ui||d([])}},id:{autoFiller:"jSAutoFiller_"+g+"_",barCorner:"jSBarCorner_"+g+"_",barLeft:"jSBarLeft_"+g+"_",barHandleFreezeLeft:"jSBarHandleFreezeLeft_"+g+"_",barMenuLeft:"jSBarMenuLeft_"+g,barTop:"jSBarTop_"+g+"_",barTopParent:"jSBarTopParent_"+g+"_",barHandleFreezeTop:"jSBarHandleFreezeTop_"+g+"_",barMenuTop:"jSBarMenuTop_"+g,barMenuParentTop:"jSBarMenuParentTop_"+g,cellMenu:"jSCellMenu_"+g,formula:"jSFormula_"+g,header:"jSHeader_"+g,menuRight:"jSMenuRight_"+g,inPlaceEdit:"jSInPlaceEdit_"+g,label:"jSLoc_"+g,menuLeft:"jSMenuLeft_"+g,pane:"jSEditPane_"+g+"_",scrollStyleX:"jSScrollStyleX_"+g+"_",scrollStyleY:"jSScrollStyleY_"+g+"_",scroll:"jSScroll_"+g+"_",sheet:"jS_"+g+"_",tab:"jSTab_"+g+"_",tabContainer:"jSTabContainer_"+g,toggleHideStyleX:"jSToggleHideX_"+g+"_",toggleHideStyleY:"jSToggleHideY_"+g+"_",title:"jSTitle_"+g,ui:"jSUI_"+g},cl:{autoFiller:"jSAutoFiller",autoFillerHandle:"jSAutoFillerHandle",autoFillerCover:"jSAutoFillerCover",barCorner:"jSBarCorner",barController:"jSBarController",barHelper:"jSBarHelper",barLeft:"jSBarLeft",barHandleFreezeLeft:"jSBarHandleFreezeLeft",barTop:"jSBarTop",barHandleFreezeTop:"jSBarHandleFreezeTop",barTopParent:"jSBarTopParent",chart:"jSChart",formula:"jSFormula",formulaParent:"jSFormulaParent",header:"jSHeader",fullScreen:"jSFullScreen",inPlaceEdit:"jSInPlaceEdit",menu:"jSMenu",menuFixed:"jSMenuFixed",parent:"jSParent",scroll:"jSScroll",sheet:"jS",label:"jSLoc",pane:"jSEditPane",tab:"jSTab",tabContainer:"jSTabContainer",title:"jSTitle",enclosure:"jSEnclosure",ui:"jSUI",uiAutoFiller:"ui-state-active",uiBar:"ui-widget-header",uiBarHighlight:"ui-state-active",uiBarHandleFreezeLeft:"ui-state-default",uiBarHandleFreezeTop:"ui-state-default",uiBarMenuTop:"ui-state-default",uiCellActive:"ui-state-active",uiCellHighlighted:"ui-state-highlight",uiControl:"ui-widget-header ui-corner-top",uiControlTextBox:"ui-widget-content",uiFullScreen:"ui-widget-content ui-corner-all",uiInPlaceEdit:"ui-state-highlight",uiMenu:"ui-widget-header",uiMenuUl:"ui-widget-header",uiMenuLi:"ui-widget-header",uiParent:"ui-widget-content ui-corner-all",uiSheet:"ui-widget-content",uiTab:"ui-widget-header",uiTabActive:"ui-state-highlight"},msg:{addRowMulti:"How many rows would you like to add?",addColumnMulti:"How many columns would you like to add?",cellFind:"What are you looking for in this spreadsheet?",cellNoFind:"No results found.",dragToFreezeCol:"Drag to freeze column",dragToFreezeRow:"Drag to freeze row",newSheet:"What size would you like to make your spreadsheet? Example: '5x10' creates a sheet that is 5 columns by 10 rows.",openSheet:"Are you sure you want to open a different sheet?  All unsaved changes will be lost.",toggleHideRow:"No row selected.",toggleHideColumn:"Now column selected.",loopDetected:"Loop Detected",newSheetTitle:"What would you like the sheet's title to be?",notFoundColumn:"Column not found",notFoundRow:"Row not found",notFoundSheet:"Sheet not found",setCellRef:"Enter the name you would like to reference the cell by.",sheetTitleDefault:"Spreadsheet {index}"},kill:function(){b.unbind("keydown");f.obj.fullScreen().remove();f.obj.inPlaceEdit().trigger("destroy");k.parent.removeClass(f.cl.uiParent).html("").removeData("sheetInstance");for(var l in d.sheet.events){k.parent.unbind(d.sheet.events[l])}d.sheet.instance[g]=null;f=null},trigger:function(l,m){m=m||[];k.parent.trigger(l,[f].concat(m))},spreadsheetsToArray:function(l){if(l||f.spreadsheets.length==0){f.cycleCellsAll(function(n,o,m){var p=d(this);f.createCell(p,n,o,m,p.text(),p.data("formula"))})}return f.spreadsheets},spreadsheetToArray:function(m,l){l=(l?l:f.i);if(m||!f.spreadsheets[l]){f.cycleCells(function(o,p,n){var q=d(this);f.createCell(q,o,p,n,q.text(),q.data("formula"))})}},createCell:function(m,q,t,l,s,p,r,n,o){if(!f.spreadsheets[q]){f.spreadsheets[q]=[]}if(!f.spreadsheets[q][t]){f.spreadsheets[q][t]=[]}f.spreadsheets[q][t][l]={td:m,formula:p||"",value:s||"",calcCount:r||0,calcLast:n||-1,calcDependenciesLast:o||-1,html:[],sheet:q};if(!f.controls.bar.y.td[q]){f.controls.bar.y.td[q]=[]}if(!f.controls.bar.y.td[q][t]){f.controls.bar.y.td[q][t]=m.parent().children().first()}if(!f.controls.bar.x.td[q]){f.controls.bar.x.td[q]=[]}if(!f.controls.bar.x.td[q][l]){f.controls.bar.x.td[q][l]=d(m[0].parentNode.parentNode.children[0].children[l])}return f.spreadsheets[q][t][l]},nav:false,setNav:function(l){d.sheet.instance.each(function(){this.nav=false});f.nav=l},controlFactory:{addRowMulti:function(m,o,l,n){if(!o){o=prompt(f.msg.addRowMulti)}if(o){if(!isNaN(o)){f.controlFactory.addCells(m,l,parseInt(o),"row",n);f.trigger("sheetAddRow",[m,l,o])}}},addColumnMulti:function(m,o,l,n){if(!o){o=prompt(f.msg.addColumnMulti)}if(o){if(!isNaN(o)){f.controlFactory.addCells(m,l,parseInt(o),"col",n);f.trigger("sheetAddColumn",[m,l,o])}}},addCells:function(v,s,C,A,w){f.autoFillerHide();f.setDirty(true);f.setChanged(true);f.obj.barHelper().remove();var z=f.obj.sheet(),x=z.width(),u=false,m;C=C||1;A=A||"col";if(v==j){v=(A=="row"?f.sheetSize().rows:f.sheetSize().cols);u=true}switch(A){case"row":m={cells:function(){var o=f.rowTds(z,v);if(!o||!o[0]){return[]}return o[0].parentNode},col:function(){return""},size:function(){var o=m.cells();return o.children.length-1},loc:function(){var o=m.cells();return f.getTdLocation(o.children[0])},newCells:function(){var o=m.size(),E="";for(var D=0;D<=o;D++){if(D==0){E+='<td class="'+f.cl.barLeft+" "+f.cl.barLeft+"_"+f.i+" "+f.cl.uiBar+'" data-entity="left" data-type="bar">'}else{E+="<td />"}}return'<tr style="height: '+k.colMargin+'px;">'+E+"</tr>"},newCol:"",offset:{row:C,col:0},start:function(){return{row:(s?v:v+C)}},createCells:function(o){o.each(function(F){var D=d(this).children(),E=(s?0:1)+v;f.spreadsheets[f.i].splice(F+E,0,[]);D.each(function(G){var H=f.controls.bar.y.td[f.i];if(G==0){f.controls.bar.y.td[f.i].splice(F+E,0,d(this))}else{f.createCell(d(this),f.i,F+E,G)}})});f.refreshRowLabels(v)}};break;case"col":m={cells:function(){var I=f.rowTds(z,1)[v],F=f.rowTds(z),H=F[F.length-1],G=f.getTdLocation(I),E=f.getTdLocation(H),D=d([]);D=D.add(f.obj.barTop(G.col));for(var o=1;o<=E.row;o++){D=D.add(f.getTd(f.i,o,G.col))}return D},col:function(){return f.col(z,v)},newCol:"<col />",loc:function(o){o=(o?o:m.cells());return f.getTdLocation(o.first())},newCells:function(){return"<td />"},offset:{row:0,col:C},start:function(){return{col:(s?v:v+C)}},createCells:function(D,F){F.width(f.s.newColumnWidth);var E=f.rows(z);for(var G=0;G<E.length;G++){var o=(s?0:1)+v,I=o+C;for(o;o<I;o++){var H=d(z[0].children[1].children[G].children[o]);if(G==0){f.controls.bar.x.td[f.i].splice(o,0,H);H.addClass(f.cl.barTop+" "+f.cl.barTop+"_"+f.i+" "+f.cl.uiBar).data("type","bar").data("entity","top").text(jSE.columnLabelString(o))}else{f.spreadsheets[f.i][G].splice(o,0,{});f.createCell(H,f.i,G,o)}}}f.refreshColumnLabels(v)}};break}var B=d(m.cells()),y=m.loc(B),n=m.col(),t=m.newCells(),l=m.newCol,q="",p="";for(var r=0;r<C;r++){q+=l;p+=t}q=d(q);p=d(p);if(s){B.before(p);d(n).before(q)}else{B.after(p);d(n).after(q)}m.createCells(p,q);if(!w&&u!=true){f.offsetFormulas(y,m.offset,s)}f.obj.pane().trigger("resizeScroll")},addRow:function(m,l){f.controlFactory.addCells(m,l,1,"row");f.trigger("sheetAddRow",[m,l,1])},addColumn:function(m,l){f.controlFactory.addCells(m,l,1,"col");f.trigger("sheetAddColumn",[m,l,1])},barLeft:function(l){f.obj.barLefts().remove();l.children("tbody").children("tr").each(function(m){if(m>0){d(this).prepend("<td  />")}})},barTop:function(n){var l=n.children("colgroup"),m=d("<col />").attr("width",k.colMargin).css("width",k.colMargin+"px").prependTo(l);f.obj.barTops().remove();var p=d('<tr class="'+f.cl.barTopParent+'" />');f.controls.barTopParent[f.i]=p;var o=n.children("tbody").children("tr:first");p.append("<td />");o.children("td").each(function(q){p.append("<td />")});p.insertBefore(o);return p},barHandleFreeze:{top:function(o){if(f.isBusy()){return false}if(!(f.scrolledArea[f.i].col.end<=(f.frozenAt().col+1))){return false}f.obj.barHelper().remove();var l=f.obj.barTop(f.frozenAt().col+1),n=l.position(),m=d('<div id="'+f.id.barHandleFreezeTop+f.i+'" class="'+f.cl.uiBarHandleFreezeTop+" "+f.cl.barHelper+" "+f.cl.barHandleFreezeTop+'" />').height(k.colMargin+k.boxModelCorrection).css("top",n.top+"px").css("left",n.left+"px").attr("title",f.msg.dragToFreezeCol).prependTo(o);f.controls.bar.helper[f.i]=f.obj.barHelper().add(m);f.controls.bar.x.handleFreeze[f.i]=m;f.draggable(m,{axis:"x",start:function(){f.setBusy(true)},stop:function(r,p){f.setBusy(false);f.setDirty(true);var q=f.nearest(m,f.controls.bar.x.tds());f.obj.barHelper().remove();f.frozenAt().col=f.getTdLocation(q).col-1;f.evt.scroll.start("x",o)},containment:"parent"})},left:function(o){if(f.isBusy()){return false}if(!(f.scrolledArea[f.i].row.end<=(f.frozenAt().row+1))){return false}f.obj.barHelper().remove();var l=f.obj.barLeft(f.frozenAt().row+1),n=l.position(),m=d('<div id="'+f.id.barHandleFreezeLeft+f.i+'" class="'+f.cl.uiBarHandleFreezeLeft+" "+f.cl.barHelper+" "+f.cl.barHandleFreezeLeft+'" />').width(k.colMargin).css("top",n.top+"px").css("left",n.left+"px").attr("title",f.msg.dragToFreezeRow).prependTo(o);f.controls.bar.helper[f.i]=f.obj.barHelper().add(m);f.controls.bar.y.handleFreeze[f.i]=m;f.draggable(m,{axis:"y",start:function(){f.setBusy(true)},stop:function(r,p){f.setBusy(false);f.setDirty(true);var q=f.nearest(m,f.controls.bar.y.tds());f.obj.barHelper().remove();f.frozenAt().row=f.getTdLocation(q).row-1;f.evt.scroll.start("y",o)},containment:"parent"})},corner:function(){}},makeMenu:function(m,l){var o;switch(m){case"top":o=d('<div id="'+f.id.barMenuTop+'" class="'+f.cl.uiMenu+" "+f.cl.menu+'" />');f.controls.bar.x.menu[f.i]=o;break;case"left":o=d('<div id="'+f.id.barMenuLeft+'" class="'+f.cl.uiMenu+" "+f.cl.menu+'" />');f.controls.bar.y.menu[f.i]=o;break;case"cell":o=d('<div id="'+f.id.cellMenu+'" class="'+f.cl.uiMenu+" "+f.cl.menu+'" />');f.controls.cellMenu[f.i]=o;break}o.mouseleave(function(){o.hide()}).appendTo(c).hide();for(var n in l){if(l[n]){if(d.isFunction(l[n])){d("<div />").text(n).data("msg",n).click(function(){l[d(this).data("msg")].apply(this,[f]);return false}).appendTo(o)}else{if(l[n]=="line"){d("<hr />").appendTo(o)}}}}return o},barMenu:{top:function(n,l,m){if(f.isBusy()){return false}var p=f.obj.barMenuTop().hide();if(!p.length){p=f.controlFactory.makeMenu("top",k.contextmenuTop)}if(!m){p.css("left",(n.pageX-5)+"px").css("top",(n.pageY-5)+"px").show();return p}var o=f.obj.barMenuParentTop().hide();if(!o.length){o=d('<div id="'+f.id.barMenuParentTop+'" class="'+f.cl.uiBarMenuTop+" "+f.cl.barHelper+'"><span class="ui-icon ui-icon-triangle-1-s" /></span></div>').mousedown(function(q){o.parent().mousedown().mouseup();var r=o.offset();p.css("left",(q.pageX-5)+"px").css("top",(q.pageY-5)+"px").show()}).blur(function(){if(p){p.hide()}}).css("padding-left",m.position().left+m.width()-k.colMargin).bind("destroy",function(){o.remove();f.controls.bar.x.menuParent[f.i]=null});f.controls.bar.x.menuParent[f.i]=o}o.prependTo(m).show()},left:function(m,l){if(f.isBusy()){return false}f.obj.barMenuLeft().hide();if(l){f.obj.barHandleFreezeLeft().remove()}var n;n=f.obj.barMenuLeft();if(!n.length){n=f.controlFactory.makeMenu("left",k.contextmenuLeft)}n.css("left",(m.pageX-5)+"px").css("top",(m.pageY-5)+"px").show();return true},corner:function(){}},cellMenu:function(l){if(f.isBusy()){return false}f.obj.cellMenu().hide();var m=f.obj.cellMenu();if(!m.length){m=f.controlFactory.makeMenu("cell",k.contextmenuCell)}m.css("left",(l.pageX-5)+"px").css("top",(l.pageY-5)+"px").show()},header:function(){f.obj.header().remove();f.obj.tabContainer().remove();var s=f.controls.header=d('<div id="'+f.id.header+'" class="'+f.cl.header+'"></div>'),q=d("<table><tr /></table>").prependTo(s),o=d("<tr />");if(k.title){if(d.isFunction(k.title)){k.title=f.title(f,g)}o.append(f.controls.title=d('<td class="'+f.cl.title+'" />').html(k.title))}function p(t){if(d.isFunction(t)){t=d(t(f))}else{t=d(t)}if(t.is("ul")){t.find("ul").hide().addClass(f.cl.uiMenuUl);t.find("li").addClass(f.cl.uiMenuLi).hover(function(){d(this).find("ul:first").hide().show()},function(){d(this).find("ul:first").hide()})}return t}if(f.isSheetEditable()){if(k.menuLeft){f.controls.menuLeft[f.i]=d('<td id="'+f.id.menuLeft+'" class="'+f.cl.menu+" "+f.cl.menuFixed+'" />').append(p(k.menuLeft)).prependTo(o);f.controls.menuLeft[f.i].find("img").load(function(){f.sheetSyncSize()})}if(k.menuRight){f.controls.menuRight[f.i]=d('<td id="'+f.id.menuRight+'" class="'+f.cl.menu+" "+f.cl.menuFixed+'" />').append(p(k.menuRight)).appendTo(o);f.controls.menuRight[f.i].find("img").load(function(){f.sheetSyncSize()})}var n=d('<td id="'+f.id.label+'" class="'+f.cl.label+'"></td>');f.controls.label=n;var r=d('<textarea id="'+f.id.formula+'" class="'+f.cl.formula+'"></textarea>').keydown(f.evt.keydownHandler.formulaKeydown).keyup(function(){f.obj.inPlaceEdit().val(f.obj.formula().val())}).change(function(){f.obj.inPlaceEdit().val(f.obj.formula().val())}).bind("paste",f.evt.pasteOverCells).focus(function(){f.setNav(false)}).focusout(function(){f.setNav(true)}).blur(function(){f.setNav(true)});f.controls.formula=r;var m=d('<table cellpadding="0" cellspacing="0" border="0"></table>').appendTo(s).append(d("<tr></tr>").append(n).append(d('<td class="'+f.cl.formulaParent+'"></td>').append(r)));var l=d("<span />");f.resizableSheet(f.obj.formula().wrap(l).parent(),{minHeight:f.obj.formula().height(),maxHeight:78,handles:"s",resize:function(u,t){f.obj.formula().height(t.size.height);f.sheetSyncSize()}});d.sheet.instance.each(function(){this.nav=false});f.setNav(true);b.keydown(f.evt.keydownHandler.documentKeydown)}o.appendTo(q);return s},ui:function(){return f.controls.ui=d('<div id="'+f.id.ui+'" class="'+f.cl.ui+'">')},tabContainer:function(){var l=f.controls.tabContainer=d('<div id="'+f.id.tabContainer+'" class="'+f.cl.tabContainer+'"></div>').mousedown(function(p){var o=d(p.target).data("i")*1;if(o>=0){f.trigger("sheetSwitch",[o])}return false}).dblclick(function(p){var o=d(p.target).data("i")*1;if(o>=0){f.trigger("sheetRename",[d(p.target).data("i")*1])}return false});if(f.isSheetEditable()){var m=d('<span class="'+f.cl.uiTab+' ui-corner-bottom" title="Add a spreadsheet" data-i="-1">+</span>').click(function(){f.addSheet({rows:25,cols:10})}).appendTo(l);if(d.fn.sortable){var n;l.sortable({placeholder:"ui-state-highlight",axis:"x",forceHelperSize:true,forcePlaceholderSize:true,opacity:0.6,cancel:'span[i="-1"]',start:function(p,o){n=o.item.index();f.trigger("sheetTabSortStart",[p,o])},update:function(p,o){f.trigger("sheetTabSortUpdate",[p,o,n])}})}}else{d("<span />").appendTo(l)}return l},scroll:function(o,m,q){var s=f.controls.scroll[f.i]=d('<div id="'+f.id.scroll+f.i+'" class="'+f.cl.scroll+'"><div></div></div>').scroll(function(){if(!f.isBusy()){f.evt.scroll.scrollTo({axis:"x",pixel:this.scrollLeft},0);f.evt.scroll.scrollTo({axis:"y",pixel:this.scrollTop},0);f.autoFillerGoToTd()}}).prependTo(o).disableSelectionSpecial().mousedown(function(){f.obj.barHelper().remove()});f.controls.scrolls=f.obj.scrolls().add(s);var p=s.children(),n=f.controls.bar.x.scroll[f.i]=d('<style type="text/css" id="'+f.id.scrollStyleX+f.i+'"></style>').bind("updateStyle",function(y,v,x){v=v||[];var w=x||d.sheet.nthCss("col","#"+f.id.sheet+f.i,this,v,f.frozenAt().col+1)+d.sheet.nthCss("td","#"+f.id.sheet+f.i+" tr",this,v,f.frozenAt().col+1);if(this.styleSheet){this.styleSheet.cssText=w}else{n.text(w)}if(!f.scrolledArea[f.i]){f.scrolledArea[f.i]={col:{start:0,end:0},row:{start:0,end:0}}}f.scrolledArea[f.i].col.start=v[0]||1;f.scrolledArea[f.i].col.end=v.pop()||1}),l=f.controls.bar.y.scroll[f.i]=d('<style type="text/css" id="'+f.id.scrollStyleY+f.i+'"></style>').bind("updateStyle",function(y,v,x){v=v||[];var w=x||d.sheet.nthCss("tr","#"+f.id.sheet+f.i,this,v,f.frozenAt().row+1);if(this.styleSheet){this.styleSheet.cssText=w}else{l.text(w)}if(!f.scrolledArea[f.i]){f.scrolledArea[f.i]={col:{start:0,end:0},row:{start:0,end:0}}}f.scrolledArea[f.i].row.start=v[0]||1;f.scrolledArea[f.i].row.end=v.pop()||1});var r,u;function t(v){if(v&&v[0]&&v[0].styleSheet){return v[0].styleSheet.cssText}return v.text()}m.append(n).append(l).bind("resizeScroll",function(){r=t(n);u=t(l);n.trigger("updateStyle");l.trigger("updateStyle");p.height(q.height()).width(q.width());s.height(o.height()).width(o.width());f.evt.scroll.start("x",m,q);f.evt.scroll.start("y",m,q);n.trigger("updateStyle",[null,r]);l.trigger("updateStyle",[null,u])});if(!d.fn.mousewheel){return}m.mousewheel(function(B,z){var H=B.originalEvent,B,C,v=function(y,x){return 0!=y%x?y:y/x};if("mousewheel"==H.type){var I=1,w=v(-H.wheelDelta,I),G,F;if(H.wheelDeltaX!==j){s.scrollTop(s[0].scrollTop+v(-H.wheelDeltaY,I)).scrollLeft(s[0].scrollLeft+v(-H.wheelDeltaX,I)).scroll()}else{s.scrollTop(s[0].scrollTop+w).scroll()}}else{B=H.detail,100<B?B=3:-100>B&&(B=-3);var D=0,A=0;switch(B){case 1:case -1:A=B*50;break;case 3:case -3:D=B*15;break}s.scrollTop(s[0].scrollTop+D).scrollLeft(s[0].scrollLeft+A).scroll()}return false})},hide:function(p,r,n){r=r||f.obj.pane();var l=f.controls.toggleHide.x[f.i]=d('<style id="'+f.id.toggleHideStyleX+f.i+'"></style>').appendTo(r).bind("updateStyle",function(t){var s=d.sheet.nthCss("col","#"+f.id.sheet+f.i,this,f.toggleHide.hiddenColumns[f.i],0)+d.sheet.nthCss("td","#"+f.id.sheet+f.i+" tr",this,f.toggleHide.hiddenColumns[f.i],0);if(this.styleSheet){this.styleSheet.cssText=s}else{l.text(s)}f.autoFillerGoToTd()}),q=f.controls.toggleHide.y[f.i]=d('<style id="'+f.id.toggleHideStyleY+f.i+'"></style>').appendTo(r).bind("updateStyle",function(t){var s=d.sheet.nthCss("tr","#"+f.id.sheet+f.i,this,f.toggleHide.hiddenRows[f.i],0);if(this.styleSheet){this.styleSheet.cssText=s}else{q.text(s)}f.autoFillerGoToTd()});k.hiddenColumns[f.i]=k.hiddenColumns[f.i]||[];k.hiddenRows[f.i]=k.hiddenRows[f.i]||[];if(!k.hiddenColumns[f.i].length||!k.hiddenRows[f.i].length){k.hiddenRows[f.i]=arrHelpers.toNumbers((n.data("hiddenrows")||"").split(","));k.hiddenColumns[f.i]=arrHelpers.toNumbers((n.data("hiddencolumns")||"").split(","))}if(f.s.hiddenRows[f.i]){for(var o in f.s.hiddenRows[f.i]){f.toggleHide.row(f.s.hiddenRows[f.i][o])}}if(k.hiddenColumns[f.i]){for(var m in k.hiddenColumns[f.i]){f.toggleHide.column(k.hiddenColumns[f.i][m])}}},sheetUI:function(m,l){if(!l){f.sheetCount=0;f.i=0}else{f.sheetCount++;f.i=l}f.tuneTableForSheetUse(m);f.readOnly[l]=m.hasClass("readonly");var o=f.controlFactory.enclosure().appendTo(f.obj.ui()),q=f.obj.pane().html(m);f.controlFactory.scroll(o,q,m);if(f.isSheetEditable()){var n=f.controlFactory.autoFiller();if(n){q.append(n)}}f.sheetDecorate(m);f.controlFactory.barTop(m);f.controlFactory.barLeft(m);f.sheetTab(true);if(f.isSheetEditable()){var p=f.obj.formula();q.mousedown(function(r){f.setNav(true);if(f.isBusy()){return false}if(f.isTd(r.target)){f.evt.cellOnMouseDown(r);return false}if(f.isBar(r.target)){f.evt.barInteraction.select(r.target);return false}}).mouseover(function(u){if(f.isBusy()){return false}if(!f.isBar(u.target)){return}var t=d(u.target),r=t.data("entity"),s=f.getBarIndex[r](u.target);if(s<0){return false}if(f.evt.barInteraction.selecting){f.evt.barInteraction.last=s;f.cellSetActiveBar(r,f.evt.barInteraction.first,f.evt.barInteraction.last)}else{f.resizeBar[r](t,s,q,m);if(f.isSheetEditable()){f.controlFactory.barHandleFreeze[r](q);if(r=="top"){f.controlFactory.barMenu[r](u,s,t)}}}}).bind("contextmenu",function(t){if(f.isBusy()){return false}if(f.isBar(t.target)){var u=d(t.target),r=u.data("entity"),s=f.getBarIndex[r](t.target);if(s<0){return false}if(f.evt.barInteraction.first==f.evt.barInteraction.last){f.controlFactory.barMenu[r](t,s)}}else{f.controlFactory.cellMenu(t)}return false}).disableSelectionSpecial().bind("cellEdit",f.evt.cellEdit).dblclick(f.evt.cellOnDblClick)}f.themeRoller.start(m);f.resizableSheet(k.parent,{minWidth:k.width*0.1,minHeight:k.height*0.1,start:function(){o.hide()},stop:function(){o.show();k.width=k.parent.width();k.height=k.parent.height();q.trigger("resizeScroll")}});f.createSpreadsheet(m,f.i);f.checkMinSize(m);f.controlFactory.tab();f.controlFactory.hide(o,q,m);f.setChanged(true);return m},enclosure:function(){var m=f.controls.pane[f.i]=d('<div class="'+f.cl.pane+'"></div>'),l=f.controls.enclosure[f.i]=d('<div class="'+f.cl.enclosure+'"></div>').append(m);f.controls.panes=f.obj.panes().add(m);f.controls.enclosures=f.obj.enclosures().add(l);return l},tab:function(){var l=f.controls.tab[f.i]=d('<span class="'+f.cl.uiTab+' ui-corner-bottom"><a class="'+f.cl.tab+'" id="'+f.id.tab+f.i+'" data-i="'+f.i+'">'+f.sheetTab(true)+"</a></span>").insertBefore(f.obj.tabContainer().find("span:last"));f.controls.tabs=f.obj.tabs().add(l);return l},inPlaceEdit:function(n,p){n=n||f.obj.cellActive();if(!n.length){n=d(f.rowTds(null,1)[1]);f.cellEdit(n)}f.obj.inPlaceEdit().trigger("destroy");var r=f.obj.formula(),o=n.offset(),l=n.attr("style"),t=n.width(),q=n.height(),m=r.val();if(!o){return}var s=f.controls.inPlaceEdit[f.i]=d('<textarea id="'+f.id.inPlaceEdit+'" class="'+f.cl.inPlaceEdit+" "+f.cl.uiInPlaceEdit+'" data-i="'+f.i+'"/>').css("left",o.left).css("top",o.top).width(t).height(q).keydown(f.evt.inPlaceEditOnKeyDown).keyup(function(){r.val(s.val())}).change(function(){r.val(s.val())}).focus(function(){f.setNav(false)}).focusout(function(){f.setNav(true)}).blur(function(){f.setNav(true)}).bind("paste",f.evt.pasteOverCells).appendTo(c).val(r.val()).focus().bind("destroy",function(){f.cellLast.isEdit=(s.val()!=m);s.remove();f.controls.inPlaceEdit[s.data("i")]=false});if(!p){s.select()}if(d.fn.elastic){s.elastic()}},autoFiller:function(){if(!k.autoFiller){return null}f.controls.autoFiller[f.i]=d('<div id="'+(f.id.autoFiller+f.i)+'" class="'+f.cl.autoFiller+" "+f.cl.uiAutoFiller+'"><div class="'+f.cl.autoFillerHandle+'" /><div class="'+f.cl.autoFillerCover+'" /></div>').mousedown(function(l){var n=f.obj.cellActive();if(n){var m=f.getTdLocation(n);f.cellSetActive(n,m,true,f.autoFillerNotGroup,function(){var p=f.obj.cellHighlighted(),o=f.getTdLocation(p.first());f.fillUpOrDown(o.row<m.row||o.col<m.col);f.autoFillerGoToTd(p.last());f.autoFillerNotGroup=false})}});return f.controls.autoFiller[f.i]}},autoFillerNotGroup:true,updateCellsAfterPasteToFormula:function(u){var t=0,s=f.obj.formula(),w=new Date();u=u||s.val();var r={row:f.cellLast.row,col:f.cellLast.col},m=s.val(),o=m;if(r.row==0&&r.col==0){return false}var x=tsv.parse(m);for(var q=0;q<x.length;q++){f.cellLast.isEdit=true;var l=x[q];for(var p=0;p<l.length;p++){t++;var n=f.getTd(f.i,q+r.row,p+r.col);n.row=r.row;n.col=r.col;if(n.length){if(!f.spreadsheets[f.i]||!f.spreadsheets[f.i][q+r.row]||!f.spreadsheets[f.i][q+r.row][p+r.col]){continue}var v=f.spreadsheets[f.i][q+r.row][p+r.col];if(v){if((l[p]+"").charAt(0)=="="){k.parent.one("sheetPreCalculation",function(){v.formula=l[p].substring(1);v.value="";n.data("formula",l[p])})}else{k.parent.one("sheetPreCalculation",function(){v.formula="";v.value=l[p];n.removeData("formula")})}f.calcDependencies(f.i,q+r.row,p+r.col);if(q==0&&p==0){o=l[p]}}}}}if(m!=o){s.val(o)}f.fillUpOrDown(false,false,o);f.evt.cellEditDone(true)},evt:{keydownHandler:{enterOnInPlaceEdit:function(l){if(!l.shiftKey){return f.evt.cellSetFocusFromKeyCode(l)}else{return true}},enter:function(l){if(!f.cellLast.isEdit&&!l.ctrlKey){f.obj.cellActive().dblclick();return false}else{return this.enterOnInPlaceEdit(l)}},tab:function(l){return f.evt.cellSetFocusFromKeyCode(l)},findCell:function(l){if(l.ctrlKey){f.cellFind();return false}return true},redo:function(l){if(l.ctrlKey&&!f.cellLast.isEdit){f.cellUndoable.undoOrRedo();return false}return true},undo:function(l){if(l.ctrlKey&&!f.cellLast.isEdit){f.cellUndoable.undoOrRedo(true);return false}return true},copy:function(p,m){var o=f.obj.cellHighlighted(),q=f.obj.formula(),n=q.val(),l=f.tdsToTsv(o,m);q.val(l).focus().select();b.one("keyup",function(){if(m){q.val("")}else{q.val(n)}});return true},cut:function(l){return this.copy(l,true)},pageUpDown:function(l){var o=f.sheetSize(),s=f.obj.pane(),n=s.height(),p=0,q=0,r;if(l){for(var m=f.cellLast.row;m>0&&p<n;m--){r=f.getTd(f.i,m,1);if(!r.data("hidden")&&r.is(":hidden")){r.show()}p+=r.parent().height()}}else{for(var m=f.cellLast.row;m<o.rows&&p<n;m++){r=f.getTd(f.i,m,1);p+=r.parent().height()}}f.cellEdit(r);return false},formulaKeydown:function(l){if(f.readOnly[f.i]){return false}if(f.cellLast.row<0||f.cellLast.col<0){return false}f.trigger("sheetFormulaKeydown",[false]);switch(l.keyCode){case key.C:if(l.ctrlKey){return f.evt.keydownHandler.copy(l)}else{f.obj.cellActive().dblclick();return true}case key.X:if(l.ctrlKey){return f.evt.keydownHandler.cut(l)}else{f.obj.cellActive().dblclick();return true}case key.ESCAPE:f.evt.cellEditAbandon();break;case key.ENTER:f.evt.cellSetFocusFromKeyCode(l);return false;break;default:f.cellLast.isEdit=true}},formulaKeydownIf:function(m,l){if(m){f.obj.cellActive().dblclick();return true}return false},documentKeydown:function(l){if(f.readOnly[f.i]){return false}if(f.cellLast.row<0||f.cellLast.col<0){return false}if(f.nav){switch(l.keyCode){case key.DELETE:f.tdsToTsv(null,true);f.obj.formula().val("");break;case key.TAB:f.evt.keydownHandler.tab(l);break;case key.ENTER:case key.LEFT:case key.UP:case key.RIGHT:case key.DOWN:(l.shiftKey?f.evt.cellSetHighlightFromKeyCode(l):f.evt.cellSetFocusFromKeyCode(l));break;case key.PAGE_UP:f.evt.keydownHandler.pageUpDown(true);break;case key.PAGE_DOWN:f.evt.keydownHandler.pageUpDown();break;case key.HOME:case key.END:f.evt.cellSetFocusFromKeyCode(l);break;case key.V:if(l.ctrlKey){return f.evt.keydownHandler.formulaKeydownIf(!f.evt.pasteOverCells(l),l)}else{f.obj.cellActive().trigger("cellEdit");return true}break;case key.Y:if(l.ctrlKey){return f.evt.keydownHandler.formulaKeydownIf(!f.evt.keydownHandler.redo(l),l)}else{f.obj.cellActive().trigger("cellEdit");return true}break;case key.Z:if(l.ctrlKey){return f.evt.keydownHandler.formulaKeydownIf(!f.evt.keydownHandler.undo(l),l)}else{f.obj.cellActive().trigger("cellEdit");return true}break;case key.ESCAPE:f.evt.cellEditAbandon();break;case key.F:if(l.ctrlKey){return f.evt.keydownHandler.formulaKeydownIf(f.evt.keydownHandler.findCell(l),l)}else{f.obj.cellActive().trigger("cellEdit");return true}break;case key.CAPS_LOCK:case key.SHIFT:case key.ALT:break;case key.CONTROL:f.obj.formula().focus().select();return true;break;default:f.obj.cellActive().trigger("cellEdit");return true;break}return false}}},pasteOverCells:function(n){if(n.ctrlKey||n.type=="paste"){var m=function(){f.updateCellsAfterPasteToFormula()};var l=b.one("keyup",function(){m();m=function(){};l.mouseup()}).one("mouseup",function(){m();m=function(){};l.keyup()});f.setDirty(true);f.setChanged(true);return true}},inPlaceEditOnKeyDown:function(l){f.trigger("sheetFormulaKeydown",[true]);switch(l.keyCode){case key.ENTER:return f.evt.keydownHandler.enterOnInPlaceEdit(l);break;case key.TAB:return f.evt.keydownHandler.tab(l);break;case key.ESCAPE:f.evt.cellEditAbandon();return false;break}},cellEditDone:function(n){f.obj.inPlaceEdit().trigger("destroy");if(f.cellLast.isEdit||n){var p=f.obj.formula(),o=f.obj.cellActive();if(f.isFormulaEditable(o)){if(o&&f.cellLast.row>0&&f.cellLast.col>0){var m=p.val(),l=f.spreadsheets[f.i][f.cellLast.row][f.cellLast.col];k.parent.one("sheetPreCalculation",function(){if(m.charAt(0)=="="){o.data("formula",m);l.value=m;l.formula=m}else{o.removeData("formula");l.value=m;l.formula=""}});f.calcDependencies(f.i,f.cellLast.row,f.cellLast.col);f.cellLast.isEdit=false;f.trigger("sheetCellEdited",[l])}}}},cellEditAbandon:function(l){f.obj.inPlaceEdit().trigger("destroy");f.themeRoller.bar.clearActive();f.themeRoller.cell.clearHighlighted();if(!l){f.calc()}f.cellLast.td=d([]);f.cellLast.row=0;f.cellLast.col=0;f.rowLast=0;f.colLast=0;f.labelUpdate("",true);f.obj.formula().val("");f.autoFillerHide();return false},cellSetFocusFromXY:function(m,l){var n=f.getTdFromXY(m,l);if(f.isTd(n)){n=d(n);f.cellEdit(n);return false}return true},cellSetHighlightFromKeyCode:function(o){var q=f.highlightedLast.colLast,n=f.highlightedLast.rowLast,l=f.sheetSize(),p;f.obj.cellActive().mousedown();switch(o.keyCode){case key.UP:n--;break;case key.DOWN:n++;break;case key.LEFT:q--;break;case key.RIGHT:q++;break}function m(s,r){if(s<1){return 1}if(s>r){return r}return s}n=m(n,l.rows);q=m(q,l.cols);f.themeRoller.cell.clearHighlighted();f.highlightedLast.colEnd=n;f.highlightedLast.rowEnd=q;f.highlightedLast.td=f.cycleCellsAndMaintainPoint(f.themeRoller.cell.setHighlighted,f.getTdLocation(f.obj.cellActive()),{row:n,col:q});p=f.getTd(f.i,n,q).mousemove().mouseup();f.highlightedLast.rowLast=n;f.highlightedLast.colLast=q;return false},cellSetFocusFromKeyCode:function(p){var s=f.cellLast.col,m=f.cellLast.row,o=false;switch(p.keyCode){case key.UP:m--;break;case key.DOWN:m++;break;case key.LEFT:s--;break;case key.RIGHT:s++;break;case key.ENTER:m++;o=true;if(f.highlightedLast.td.length>1){var n=f.obj.inPlaceEdit(),l=n.val();n.trigger("destroy");f.updateCellsAfterPasteToFormula(l);return true}else{if(k.autoAddCells){if(f.cellLast.row==f.sheetSize().rows){f.controlFactory.addRow()}}}break;case key.TAB:o=true;if(p.shiftKey){s--}else{s++}if(k.autoAddCells){if(f.cellLast.col==f.sheetSize().cols){f.controlFactory.addColumn()}}break;case key.HOME:s=1;break;case key.END:s=f.obj.cellActive().parent().children("td").length-1;break}s=(s?s:1);m=(m?m:1);if(!f.cellLast.isEdit||o){var q=f.getTd(f.i,m,s);if(q){f.cellEdit(q);return false}}return true},cellOnMouseDown:function(l){f.obj.formula().blur();if(l.shiftKey){f.getTdRange(l,f.obj.formula().val())}else{f.cellEdit(d(l.target),true)}},cellOnDblClick:function(l){if(f.isBusy()){return false}f.controlFactory.inPlaceEdit(null,true)},cellEdit:function(l){if(f.isBusy()){return false}f.controlFactory.inPlaceEdit()},barInteraction:{first:0,last:0,selecting:false,select:function(n){if(!n){return}if(!f.isBar(n)){return}n=d(n);var l=n.data("entity"),m=f.getBarIndex[l](n[0]);if(m<0){return false}f[l+"Last"]=m;f.evt.barInteraction.last=f.evt.barInteraction.first=m;f.cellSetActiveBar(l,f.evt.barInteraction.first,f.evt.barInteraction.last);f.evt.barInteraction.first=f.evt.barInteraction.last=f[l+"Last"]=m;f.evt.barInteraction.selecting=true;b.one("mouseup",function(){f.evt.barInteraction.selecting=false});return false}},scroll:{axis:{x:{},y:{}},size:{},td:{},start:function(o,r,n){f.autoFillerHide();r=r||f.obj.pane();n=n||f.obj.sheet();var p=f.evt.scroll;p.size=f.sheetSize(n);p.td=f.obj.cellActive();p.axis[o].v=[];p.axis[o].p=[];switch(o||"x"){case"x":var l=p.axis.x;l.max=p.size.cols;l.min=1;l.scrollStyle=f.obj.scrollStyleX().trigger("updateStyle");l.area=r.width();l.sheetArea=n.width();l.scrollUpdate=function(s){s=s||f.obj.scroll();s.scrollLeft(l.value*(s.width()/p.size.cols));return};break;case"y":var q=p.axis.y;q.max=p.size.rows;q.min=1;q.scrollStyle=f.obj.scrollStyleY().trigger("updateStyle");q.area=r.height();q.sheetArea=n.height();q.scrollUpdate=function(s){s=s||f.obj.scroll();s.scrollTop(q.value*(s.height()/p.size.rows));return};break}p.axis[o].gridSize=100/(p.axis[o].max-p.axis[o].min);for(var m=p.axis[o].min;m<=p.axis[o].max;m++){p.axis[o].v[m]=p.axis[o].gridSize*m;p.axis[o].p[p.axis[o].gridSize*m]=m+1}},scrollTo:function(o){o=o||{};o.axis=o.axis||"x";o.value=o.value||0;o.pixel=o.pixel||1;if(!f.evt.scroll.axis){f.evt.scroll.start(o.axis)}var n=f.evt.scroll.axis[o.axis];if(!o.value){if(!n.p){return}o.value=n.p[arrHelpers.getClosestValues(n.v,Math.abs(o.pixel/(n.sheetArea-n.area))*100)]}o.max=o.max||n.max;var m=n.min,l=[];while(m<=o.value||m<=o.max){if(m<o.value&&m>=n.min){l.push(m)}m++}if(l.length){if(n.scrollStyle){n.scrollStyle.trigger("updateStyle",[l])}}else{if(n.scrollStyle){n.scrollStyle.trigger("updateStyle")}}n.value=o.value},stop:function(){if(this.axis.x.scrollUpdate){this.axis.x.scrollUpdate()}if(this.axis.y.scrollUpdate){this.axis.y.scrollUpdate()}if(f.evt.scroll.td){f.evt.scroll.td=null;f.autoFillerGoToTd()}}}},scrollRefresh:function(l){if(!l){return}if(l.row){f.evt.scroll.start("x");f.evt.scroll.scrollTo({axis:"x",value:l.row});f.evt.scroll.stop()}if(l.col){f.evt.scroll.start("y");f.evt.scroll.scrollTo({axis:"y",value:l.col});f.evt.scroll.stop()}},refreshColumnLabels:function(n){n=n||0;f.obj.barMenuParentTop().trigger("destroy");var m=f.controls.bar.x.td[f.i];if(!m){return}for(var l=n;l<m.length;l++){if(l){d(m[l]).text(jSE.columnLabelString(l))}}},refreshRowLabels:function(n){n=n||0;var m=f.controls.bar.y.td[f.i];if(!m){return}for(var l=n;l<m.length;l++){if(l){d(m[l]).text(l)}}},isTd:function(l){if(!l){return false}l=(l[0]?l[0]:[l]);if(l[0]){if(!isNaN(l[0].cellIndex)){if(l[0].cellIndex>0&&l[0].parentNode.rowIndex>0){return true}}}return false},isBar:function(l){if(!l){return false}l=(l[0]?l[0]:[l]);if(l[0]){if(!isNaN(l[0].cellIndex)){if(l[0].cellIndex==0||l[0].parentNode.rowIndex==0){return true}}}return false},readOnly:[],isSheetEditable:function(l){l=l||f.i;return(k.editable==true&&!f.readOnly[l])},isFormulaEditable:function(l){if(k.lockFormulas){if(l.data("formula")!==j){return false}}return true},toggleFullScreen:function(){if(!f){return}f.evt.cellEditDone();var m=f.obj.fullScreen();if(m.is(":visible")){c.removeClass("bodyNoScroll");k.parent=m.data("parent");var l=k.parent.width(),o=k.parent.height();k.width=l;k.height=o;k.parent.append(m.children());m.remove();f.sheetSyncSize();f.obj.pane().trigger("resizeScroll");f.trigger("sheetFullScreen",[false])}else{c.addClass("bodyNoScroll");var l=a.width()-15,o=a.height()-15,n=k.parent;k.width=l;k.height=o;k.parent=f.controls.fullScreen[f.i]=d('<div class="'+f.cl.fullScreen+" "+f.cl.uiFullScreen+'" />').append(k.parent.children()).appendTo(c).data("parent",k.parent);f.obj.pane().trigger("resizeScroll");f.sheetSyncSize();n.trigger("sheetFullScreen",[true])}},renameSheet:function(l){if(isNaN(l)){return false}if(l>-1){f.sheetTab()}},switchSheet:function(l){if(isNaN(l)){return false}if(l==-1){f.addSheet("5x10")}else{if(l!=f.i){f.setActiveSheet(l);f.calc(l)}}},tuneTableForSheetUse:function(n){f.controls.sheet[f.i]=n.addClass(f.cl.sheet).attr("id",f.id.sheet+f.i).attr("border","1px").attr("cellpadding","0").attr("cellspacing","0");f.controls.sheets=f.obj.sheets().add(n);var m=n.data("frozenatrow"),l=n.data("frozenatcol");if(!f.s.frozenAt[f.i]){f.s.frozenAt[f.i]={row:0,col:0}}if(m){f.s.frozenAt[f.i].row=m}if(l){f.s.frozenAt[f.i].col=l}return n},createSpreadsheet:function(m,l,o){m=m||f.obj.sheet();l=l||f.i;o=d.extend({row:0,col:0},o);f.spreadsheets[l]=[];var n=f.rows(m);d(n).each(function(p){d(this).children().each(function(q){var r=d(this);if(p>0&&q>0){f.createCell(r,l,p,q,r.text(),r.data("formula"))}else{if(q==0&&p>0){r.data("type","bar").data("entity","left").text(p).attr("id",f.id.barLeft+p+"_"+f.i).attr("class",f.cl.barLeft+" "+f.cl.barLeft+"_"+f.i+" "+f.cl.uiBar)}if(p==0&&q>0){r.data("type","bar").data("entity","top").text(jSE.columnLabelString(q)).attr("id",f.id.barTop+q+"_"+f.i).attr("class",f.cl.barTop+" "+f.cl.barTop+"_"+f.i+" "+f.cl.uiBar)}if(p==0&&q==0){f.controls.bar.corner[f.i]=r.data("type","bar").data("entity","corner").attr("id",f.id.barCorner+f.i).attr("class",f.cl.uiBar+"  "+f.cl.barCorner)}}})})},toggleHide:{hiddenRows:[],row:function(m){m=m||f.rowLast;if(!m){return}var o=f.rows()[m],l=d(o),n=[];if(!this.hiddenRows[f.i]){this.hiddenRows[f.i]=[]}if(l.length&&d.inArray(m+1,this.hiddenRows[f.i])<0){this.hiddenRows[f.i].push(m+1)}else{this.hiddenRows[f.i].splice(this.hiddenRows[f.i].indexOf(m+1),1)}f.obj.toggleHideStyleY().trigger("updateStyle")},rowShowAll:function(){d.each(this.hiddenRows[f.i],function(l){d(this).removeData("hidden")});f.obj.toggleHideStyleY().html("");this.hiddenRows[f.i]=[]},hiddenColumns:[],columnIndexOffset:[],column:function(m){m=m||f.colLast;if(!m){return}var l=f.cols()[m],o=d(l),n=[];if(!this.hiddenColumns[f.i]){this.hiddenColumns[f.i]=[]}if(o.length&&d.inArray(m+1,this.hiddenColumns[f.i])<0){this.hiddenColumns[f.i].push(m+1)}else{this.hiddenColumns[f.i].splice(this.hiddenColumns[f.i].indexOf(m+1),1)}f.obj.toggleHideStyleX().trigger("updateStyle")},columnShowAll:function(){f.obj.toggleHideStyleX().html("");this.hiddenColumns[f.i]=[]}},merged:[],merge:function(){var o=[],p=f.obj.cellHighlighted(),r=f.getTdLocation(p.first()),t=f.getTdLocation(p.last()),s=0,w=0,u=f.spreadsheets[f.i][r.row][r.col],y=new Date();if(p.length>1&&r.row){f.setDirty(true);f.setChanged(true);if(!f.merged[f.i+"_"+r.row+"_"+r.col]){f.merged[f.i+"_"+r.row+"_"+r.col]=[]}var v=f.merged[f.i+"_"+r.row+"_"+r.col];for(var B=r.row;B<=t.row;B++){if(B){w++}for(var l=r.col;l<=t.col;l++){if(B==r.row){s++}var m=f.getTd(f.i,B,l),x=f.spreadsheets[f.i][B][l],n=f.spreadsheets[f.i][B][r.col-1]||f.spreadsheets[f.i][B][r.col],A=f.spreadsheets[f.i][B][t.col+1]||f.spreadsheets[f.i][B][t.col],q=f.spreadsheets[f.i][t.row-1][t.col]||f.spreadsheets[f.i][t.row][t.col],z=f.spreadsheets[f.i][t.row+1][t.col]||f.spreadsheets[f.i][t.row][t.col];v.push(x);o.push(x.formula?"("+x.formula.substring(1)+")":x.value);k.parent.one("sheetPreCalculation",function(){if(l!=r.col||B!=r.row){x.formula=null;x.value="";x.html="";x.defer=u;x.right=A;x.down=z;x.left=n;x.up=q;m.removeData("formula").html("").hide()}});f.calcDependencies(f.i,B,l,y)}}u.value=o.join(" ");u.formula=(u.formula?o.join(" "):"");p.first().show().attr("rowSpan",w).attr("colSpan",s);f.calcDependencies(f.i,r.row,r.col);f.evt.cellEditDone()}},unmerge:function(){var n=f.obj.cellHighlighted().first(),p=f.getTdLocation(n),q=f.spreadsheets[f.i][p.row][p.col],r=n.data("formula"),t=new Date();var l=Math.max(n.attr("rowSpan")*1,1);var o=Math.max(n.attr("colSpan")*1,1);for(var u=p.row;u<=p.row+l;u++){for(var m=p.col;m<=p.col+o;m++){var n=f.getTd(f.i,u,m).show().removeAttr("colSpan").removeAttr("rowSpan"),s=f.spreadsheets[f.i][u][m];s.up=s.down=s.left=s.right=s.defer=null;f.calcDependencies(f.i,u,m,t)}}},fillUpOrDown:function(s,r,u){var y=f.obj.cellHighlighted(),l=f.obj.cellActive(),t=new Date();var w=l.hasClass(f.cl.uiCellHighlighted),p=f.getTdLocation(y.first()),x=f.getTdLocation(y.last());u=(u?u:f.obj.formula().val());var o={row:0,col:0},n,m=u,q;if(u.charAt(0)=="="){q=function(z,A,v){n=d(this);if(s){o.row=-x.row+A;o.col=-x.col+v}else{o.row=A-p.row;o.col=v-p.col}m=f.reparseFormula(u,o);f.spreadsheets[z][A][v].formula=m;n.data("formula",m).html("")}}else{if(s&&!isNaN(m)){m*=1;m-=x.row;m-=x.col}q=function(z,A,v){n=d(this);k.parent.one("sheetPreCalculation",function(){f.spreadsheets[z][A][v].formula="";f.spreadsheets[z][A][v].value=m;n.removeData("formula")});f.calcDependencies(z,A,v,t);if(!isNaN(m)&&m!=""){m++}}}f.cycleCells(q,p,x)},tdsToTsv:function(n,o,s){n=n||f.obj.cellHighlighted();s=s||function(w,v){if(o){k.parent.one("sheetPreCalculation",function(){v.formula="";v.value=""});f.calcDependencies(f.i,w.row,w.col,r)}};var u=[],t,q=f.obj.formula(),l=q.val(),p=0,r=new Date();n.each(function(w){var y=f.getTdLocation(n[w]),v=f.spreadsheets[f.i][y.row][y.col],x=(v.formula?"="+v.formula:v.value);if(!p){p=y.row}if(!u[y.row-p]){u[y.row-p]=[]}if((x+"").match(/\n/)){x='"'+x+'"'}u[y.row-p].push(x||"");s.apply(this,[y,v])});for(var m in u){u[m]=u[m].join("\t")}return u.join("\n")},offsetFormulas:function(r,q,m){var l=f.sheetSize(),p={first:r,last:{row:l.rows,col:l.cols}},n={first:{row:0,col:0},last:{row:l.rows,col:l.cols}};f.log("offsetFormulas from - Col:"+r.col+",Row:"+r.row);f.log("Is before loc:"+(m?"true":"false"));f.log("Offset: - Col:"+q.col+",Row:"+q.row);function o(u,s){var t=false;if(m){if(u>=s){t=true}}else{if(u>s){t=true}}return t}f.cycleCells(function(t,u,s){var w=d(this),v=w.data("formula");if(v&&f.isFormulaEditable(w)){v=f.reparseFormula(v,q,function(x){return{row:o(x.row,r.row),col:o(x.col,r.col)}});f.spreadsheets[t][u][s].formula=v;w.data("formula",v)}},n.first,n.last);f.evt.cellEditDone();f.calc()},reparseFormula:function(n,m,l){return n.replace(jSE.regEx.cell,function(p,q,s,t){if(q=="SHEET"){return p}var r=jSE.parseLocation(p);if(l){var o=l(r);if(o.col||o.row){if(o.col){r.col+=m.col}if(o.row){r.row+=m.row}return f.makeFormula(r)}}else{return f.makeFormula(r,m)}return p})},makeFormula:function(m,l){l=d.extend({row:0,col:0},l);m.col+=l.col;m.row+=l.row;if(m.col<0){m.col=0}if(m.row<0){m.row=0}return jSE.parseCellName(m.col,m.row)},cycleCells:function(o,r,p,n){n=n||f.i;r=r||{row:0,col:0};if(!p){var m=f.sheetSize(d("#"+f.id.sheet+n));p={row:m.rows,col:m.cols}}for(var q=r.row;q<=p.row;q++){for(var l=r.col;l<=p.col;l++){var s=f.getTd(n,q,l);if(s){o.apply(s,[n,q,l])}}}},cycleCellsAll:function(o){for(var n=0;n<=f.sheetCount;n++){var m=f.sheetSize(d("#"+f.id.sheet+n)),l={row:m.rows,col:m.cols};f.cycleCells(o,{row:0,col:0},l,n)}},cycleCellsAndMaintainPoint:function(r,s,p){var n=d([]),q=Math.min(s.row,p.row),u=Math.min(s.col,p.col),l=Math.max(s.row,p.row),o=Math.max(s.col,p.col);for(var t=q;t<=l;t++){for(var m=u;m<=o;m++){n=n.add(f.getTd(f.i,t,m));r(n[n.length-1])}}return n},sheetDecorate:function(l){f.formatSheet(l);f.sheetDecorateRemove(false,l)},formatSheet:function(r){var l=k.newColumnWidth,p=k.colMargin,n=r.children("tbody");if(n.length<1){n=d("<tbody />");r.wrapInner(n)}var m=r.children("colgroup");if(m.length<1||m.children("col").length<1){r.remove("colgroup");m=d("<colgroup />").prependTo(r);var q=n.children("tr:first");q.children().each(function(){d("<col />").width(l).css("width",l+"px").attr("width",l+"px").appendTo(m)});n.children("tr").each(function(){d(this).height(p).css("height",p+"px").attr("height",p+"px")})}r.removeAttr("width").css("width","")},checkMinSize:function(n){var m=f.sheetSize(n),p=0,l=0;if(m.cols<k.minSize.cols){f.controlFactory.addColumnMulti(null,k.minSize.cols-m.cols)}if(m.rows<k.minSize.rows){f.controlFactory.addRowMulti(null,k.minSize.rows-m.rows)}},themeRoller:{start:function(l){k.parent.addClass(f.cl.uiParent);l.addClass(f.cl.uiSheet);f.obj.header().addClass(f.cl.uiControl);f.obj.label().addClass(f.cl.uiControl);f.obj.formula().addClass(f.cl.uiControlTextBox)},cell:{setHighlighted:function(l){d(l).addClass(f.cl.uiCellHighlighted)},isHighlighted:function(){return(f.highlightedLast.td.length?true:false)},clearHighlighted:function(){if(f.themeRoller.cell.isHighlighted()){f.obj.cellHighlighted().removeClass(f.cl.uiCellHighlighted)}f.highlightedLast.rowStart=0;f.highlightedLast.colStart=0;f.highlightedLast.rowEnd=0;f.highlightedLast.colEnd=0;f.highlightedLast.td=d([])}},bar:{style:function(l){d(l).addClass(f.cl.uiBar)},setActive:function(m,l){switch(m){case"top":f.obj.barTop(l).addClass(f.cl.uiBarHighlight);break;case"left":f.obj.barLeft(l).addClass(f.cl.uiBarHighlight);break}},clearActive:function(){f.obj.barTops().removeClass(f.cl.uiBarHighlight);f.obj.barLefts().removeClass(f.cl.uiBarHighlight)}},tab:{setActive:function(l){this.clearActive();f.obj.tab().addClass(f.cl.uiTabActive)},clearActive:function(){f.obj.tabContainer().find("span."+f.cl.uiTabActive).removeClass(f.cl.uiTabActive)}}},resizable:function(m,l){if(!m.data("resizable")){m.resizable(l)}},frozenAt:function(){if(!f.s.frozenAt[f.i]){f.s.frozenAt[f.i]={row:0,col:0}}return f.s.frozenAt[f.i]},busy:[],setBusy:function(l){if(l){f.busy.push(l)}else{f.busy.pop()}},isBusy:function(){return(f.busy.length>0?true:false)},draggable:function(m,l){if(!m.data("jSdraggable")){m.data("jSdraggable",true).draggable(l)}},nearest:function(m,l){return d(m).nearest(l)},resizeBar:{top:function(o,m,p,l){f.obj.barTopControls().remove();var n=d('<div class="'+f.cl.barController+'" />').width(o.width()).height(0).prependTo(o);f.controls.bar.x.controls[f.i]=f.obj.barTopControls().add(n);f.resizableCells(n,{handles:"e",start:function(r,q){f.autoFillerHide();f.setBusy(true);this.col=d(f.col(l,m))},resize:function(r,q){this.col.width(q.size.width).attr("width",q.size.width+"px").css("width",q.size.width+"px")},stop:function(r,q){f.setBusy(false);p.trigger("resizeScroll");f.followMe();f.setDirty(true)}})},left:function(p,m,s,l){f.obj.barLeftControls().remove();var q=p.offset(),n=d('<div class="'+f.cl.barController+'"></div>').prependTo(p).offset({top:q.top,left:q.left});f.controls.bar.y.controls[f.i]=f.obj.barLeftControls().add(n);var r=d('<div class="barControllerChild"></div>').height(p.height()).prependTo(n),o=p.parent().add(p).add(n);f.resizableCells(r,{handles:"s",start:function(){f.autoFillerHide();f.setBusy(true)},resize:function(u,t){o.height(t.size.height).attr("height",(t.size.height)).css("height",t.size.height+"px")},stop:function(u,t){f.setBusy(false);s.trigger("resizeScroll");f.followMe();f.setDirty(true)}})},corner:function(){}},sheetDecorateRemove:function(m,l){l=l||f.obj.sheets();l=(m?l.clone():l);l.find("td."+f.cl.uiCellActive).removeClass(f.cl.uiCellActive);l.find("td."+f.cl.uiCellHighlighted).removeClass(f.cl.uiCellHighlighted);return l},sheetBarsRemove:function(l){l=d(l?l:f.obj.sheets());l.find("tr."+f.cl.barTopParent).remove();l.find("td."+f.cl.barLeft).remove();return l},labelUpdate:function(m,l){if(!l){m=jSE.parseCellName(m.col,m.row);if(m){f.obj.label().text(m)}}else{f.obj.label().text(m)}},cellEdit:function(q,n){if(q.is(f.cellLast.td)){return}f.autoFillerNotGroup=true;f.evt.cellEditDone();var o=f.getTdLocation(q);if(!f.spreadsheets[f.i]||!f.spreadsheets[f.i][o.row]||!f.spreadsheets[f.i][o.row][o.col]){return}var l=f.spreadsheets[f.i][o.row][o.col],m;f.trigger("sheetCellEdit",[l]);f.followMe(q);f.labelUpdate(o);if(l.formula){m="="+l.formula}else{m=l.value}var p=f.obj.formula().val(m).blur();f.cellSetActive(q,o,n)},cellSetActive:function(s,r,o,m,q){if(r.col!=j){f.cellLast.td=s;f.cellLast.row=f.rowLast=r.row;f.cellLast.col=f.colLast=r.col;f.themeRoller.bar.clearActive();f.themeRoller.cell.clearHighlighted();f.highlightedLast.td=s;f.themeRoller.cell.setHighlighted(s);f.themeRoller.bar.setActive("left",f.cellLast.row);f.themeRoller.bar.setActive("top",f.cellLast.col);var l,p;f.highlightedLast.rowStart=r.row;f.highlightedLast.colStart=r.col;f.highlightedLast.rowLast=r.row;f.highlightedLast.colLast=r.col;switch(k.cellSelectModel){case"excel":case"gdrive":l=function(){};p=f.themeRoller.cell.clearHighlighted;break;case"oo":l=function(t){var u=d(t);if(f.isTd(u)){f.cellEdit(u)}};p=function(){};break}if(o){var n=r;f.obj.pane().mousemove(function(v){if(f.isBusy()){return false}var t=f.getTdLocation(v.target);if(t.col<1||t.row<1){return false}var u=true;if(m){u=false;if(r.col==t.col||r.row==t.row){u=true}}if((n.col!=t.col||n.row!=t.row)&&u){p();f.highlightedLast.colEnd=t.col;f.highlightedLast.rowEnd=t.row;l(v.target);f.highlightedLast.td=f.cycleCellsAndMaintainPoint(f.themeRoller.cell.setHighlighted,r,t)}n=t});b.one("mouseup",function(){f.obj.pane().unbind("mousemove").unbind("mouseup");if(d.isFunction(q)){q()}})}}},colLast:0,rowLast:0,cellLast:{td:d([]),row:0,col:0,isEdit:false},highlightedLast:{td:d([]),rowStart:0,colStart:0,rowEnd:0,colEnd:0},cellStyleToggle:function(n,m){f.setDirty(true);var l=f.obj.cellHighlighted();if(m){l.removeClass(m)}if(l.hasClass(n)){l.removeClass(n)}else{l.addClass(n)}return false},fontReSize:function(n){var l=0;switch(n){case"up":l=1;break;case"down":l=-1;break}var m=f.obj.cellHighlighted();m.each(function(p){cell=d(this);var o=(cell.css("font-size")+"").replace("px",""),q=parseInt(o?o:10)+l;cell.css("font-size",q+"px")})},callStack:0,updateCellValue:function(o,q,n){if(!f.spreadsheets[o]){return k.error({error:f.msg.notFoundSheet})}if(!f.spreadsheets[o][q]){return k.error({error:f.msg.notFoundRow})}if(!f.spreadsheets[o][q][n]){return k.error({error:f.msg.notFoundColumn})}var l=f.spreadsheets[o][q][n];l.oldValue=l.value;if(l.result){delete l.result}switch(l.state){case"updating":return k.error({error:f.msg.loopDetected});case"updatingDependencies":return l.value}if(l.defer){return this.updateCellValue(l.defer.sheet,l.defer.row,l.defer.col)}l.state="updating";l.html=[];l.fnCount=0;l.result=null;if(l.calcLast!=f.calcLast||l.calcDependenciesLast!=f.calcDependenciesLast){l.calcLast=f.calcLast;l.calcDependenciesLast=f.calcDependenciesLast;l.calcCount++;if(l.formula){try{if(l.formula.charAt(0)=="="){l.formula=l.formula.substring(1,l.formula.length)}var m;if(f.callStack){if(!l.formulaParser){l.formulaParser=(new f.formulaParser)}m=l.formulaParser}else{m=f.FormulaParser}f.callStack++;m.lexer.obj={type:"cell",sheet:o,row:q,col:n,obj:l,s:k,editable:k.editable,jS:f,error:k.error};m.lexer.handler=f.cellHandler;l.result=m.parse(l.formula)}catch(p){l.result=p.toString();f.alertFormulaError(l.value)}f.callStack--}l=f.filterValue(l,o,q,n)}l.state=null;return l.value},updateCellDependencies:function(p,s,n){var l=f.spreadsheets[p][s][n];if(l.state){return}l.state="updatingDependencies";var r=d.extend({},l.dependencies);l.dependencies=[];for(var o in r){var m=r[o],q=f.getTdLocation(m.td);f.updateCellValue(m.sheet,q.row,q.col);if(q.row&&q.col){f.updateCellDependencies(m.sheet,q.row,q.col)}}l.state=null},filterValue:function(l,n,o,m){l=l||{};if(l.result!=j){l.value=l.result;f.getTd(n,o,m).html(l.html.length>0?l.html:k.encode(l.value))}else{if(l.html.length>0){f.getTd(n,o,m).html(l.html)}else{f.getTd(n,o,m).html(k.encode(l.value))}}return l},cellHandler:{variable:function(){if(arguments.length){var m=arguments[0],l=arguments[1];switch(m.toLowerCase()){case"true":return jFN.TRUE();case"false":return jFN.FALSE()}if(f.s.formulaVariables[m]&&!l){return f.s.formulaVariables[m]}else{if(f.s.formulaVariables[m]&&l){return f.s.formulaVariables[m][l]}else{return""}}}},time:function(m,l){return times.fromString(m,l)},concatenate:function(){f.spreadsheets[this.sheet][this.row][this.col].html=[];return jFN.CONCATENATE.apply(this,arguments).value},cellValue:function(m){var l=jSE.parseLocation(m);f.cellHandler.createDependency.apply(this,[this.sheet,l]);return f.updateCellValue(this.sheet,l.row,l.col)},createDependency:function(l,m){if(!f.spreadsheets[l]){return}if(!f.spreadsheets[l][m.row]){return}if(!f.spreadsheets[l][m.row][m.col]){return}if(!f.spreadsheets[this.sheet]){return}if(!f.spreadsheets[this.sheet][this.row]){return}if(!f.spreadsheets[this.sheet][this.row][this.col]){return}if(!f.spreadsheets[l][m.row][m.col].dependencies){f.spreadsheets[l][m.row][m.col].dependencies={}}f.spreadsheets[l][m.row][m.col].dependencies[this.sheet+"_"+this.row+"_"+this.col]=f.spreadsheets[this.sheet][this.row][this.col]},cellRangeValue:function(p,m){p=jSE.parseLocation(p);m=jSE.parseLocation(m);var l=[];for(var o=p.row;o<=m.row;o++){for(var n=p.col;n<=m.col;n++){f.cellHandler.createDependency.apply(this,[this.sheet,{row:o,col:n}]);l.push(f.updateCellValue(this.sheet,o,n))}}return[l]},fixedCellValue:function(l){l=l.replace(/\$/g,"");return f.cellHandler.cellValue.apply(this,[l])},fixedCellRangeValue:function(m,l){m=m.replace(/\$/g,"");l=l.replace(/\$/g,"");return f.cellHandler.cellRangeValue.apply(this,[m,l])},remoteCellValue:function(l,n){var m=jSE.parseLocation(n);l=jSE.parseSheetLocation(l);f.cellHandler.createDependency.apply(this,[l,m]);return f.updateCellValue(l,m.row,m.col)},remoteCellRangeValue:function(p,q,m){p=jSE.parseSheetLocation(p);q=jSE.parseLocation(q);m=jSE.parseLocation(m);var l=[];for(var o=q.row;o<=m.row;o++){for(var n=q.col;n<=m.col;n++){l.push(f.updateCellValue(p,o,n))}}return[l]},callFunction:function(q,o,m){q=q.toUpperCase();if(!o){o=[""]}else{if(d.isArray(o)){o=o.reverse()}else{o=[o]}}if(d.sheet.fn[q]){f.spreadsheets[m.sheet][m.row][m.col].fnCount++;var n=[],p=[];for(i in o){if(o[i]){if(o[i].value||o[i].html){n.push(o[i].value);p.push(o[i].html)}else{n.push(o[i]);p.push(o[i])}}}m.html=p;var l=d.sheet.fn[q].apply(m,n);if(l!=null){if(l.html!=j){f.spreadsheets[m.sheet][m.row][m.col].html=l.html}if(l.value!=j){return l.value}}return l}else{return k.error({error:"Function "+q+" Not Found"})}}},cellLookupHandlers:{fixedCellValue:function(l){return[f.sheet,jSE.parseLocation(l),jSE.parseLocation(l)]},fixedCellRangeValue:function(m,n,l){return[jSE.parseSheetLocation(m),jSE.parseLocation(n),jSE.parseLocation(l)]},cellValue:function(l){},cellRangeValue:function(m,n,l){return[f.sheet,jSE.parseLocation(n),jSE.parseLocation(l)]},remoteCellValue:function(l,m){return[f.sheet,jSE.parseLocation(m),jSE.parseLocation(m)]},remoteCellRangeValue:function(m,n,l){return[jSE.parseSheetLocation(m),jSE.parseLocation(n),jSE.parseLocation(l)]},callFunction:function(){if(arguments[0]=="VLOOKUP"||arguments[0]=="HLOOKUP"&&arguments[1]){return arguments[1].reverse()[1]}}},cellLookup:function(){var l=(new f.formulaParser);l.lexer.obj=this.obj;l.lexer.handler=d.extend(l.lexer.handler,f.cellLookupHandlers);var n=l.parse(this.obj.formula),o=[];for(var p=n[1].row;p<=n[2].row;p++){for(var m=n[1].col;m<=n[2].col;m++){o.push({sheet:n[0],row:p,col:m})}}return o},alertFormulaError:function(l){alert("cell:"+row+" ;"+col+'\nvalue: "'+cell.formula+'"\nerror: \n'+e)},calcLast:0,calcDependenciesLast:0,calc:function(l){l=(l?l:f.i);if(f.readOnly[l]||f.isChanged()===false){return}f.log("Calculation Started");f.calcLast=new Date();jSE.calc(l,f.spreadsheetsToArray()[l],f.updateCellValue);f.trigger("sheetCalculation",[{which:"speadsheet"}]);f.setChanged(false);f.log("Calculation Ended")},calcDependencies:function(m,o,l,n){f.calcDependenciesLast=n||new Date();f.cellUndoable.add(m,o,l);f.trigger("sheetPreCalculation",[{which:"cell",sheet:m,row:o,cell:l}]);f.setDirty(true);f.setChanged(true);f.updateCellValue(m,o,l);f.updateCellDependencies(m,o,l);f.trigger("sheetCalculation",[{which:"cell",sheet:m,row:o,cell:l}]);f.cellUndoable.add(m,o,l,true)},addSheet:function(l){if(!l){l=prompt(f.msg.newSheet);l=l.toLowerCase().split("x");l={cols:d.trim(l[0])*1,rows:d.trim(l[1])*1}}if(l){f.evt.cellEditAbandon();f.setDirty(true);var m=f.controlFactory.sheetUI(d.sheet.makeTable.fromSize(l),f.sheetCount+1);f.setActiveSheet(f.sheetCount);f.sheetSyncSize();f.trigger("sheetAdd",[f.i])}},deleteSheet:function(l){var m=l||f.i;f.obj.barHelper().remove();f.obj.pane().remove();f.obj.tabContainer().children().eq(f.i).remove();f.spreadsheets[m]=null;f.i=0;f.sheetCount--;f.setActiveSheet(f.i);f.setDirty(true);f.setChanged(true);f.trigger("sheetDelete",[m])},deleteRow:function(l){f.getTd(f.i,f.rowLast,1).parent().remove();f.controls.bar.y.td[f.i].splice(f.rowLast,1);f.spreadsheets[f.i].splice(f.rowLast,1);f.refreshRowLabels(f.rowLast);f.setChanged(true);f.offsetFormulas({row:f.rowLast,col:0},{row:-1,col:0});f.setDirty(true);f.evt.cellEditAbandon();f.obj.pane().trigger("resizeScroll");f.trigger("sheetDeleteRow",f.rowLast)},deleteColumn:function(l){if(f.colLast<1){return}f.obj.barHelper().remove();var o=f.obj.sheet(),n=f.sheetSize(o);for(var m=1;m<=n.rows;m++){f.getTd(f.i,m,f.colLast).remove()}f.obj.barTop(f.colLast).remove();f.controls.bar.x.td[f.i].splice(f.colLast,1);for(var p in f.spreadsheets[f.i]){f.spreadsheets[f.i][p].splice(f.colLast,1)}d(f.col(o,f.colLast)).remove();f.refreshColumnLabels(f.colLast);f.setChanged(true);f.offsetFormulas({row:0,col:f.colLast},{row:0,col:-1});f.setDirty(true);f.evt.cellEditAbandon();f.obj.pane().trigger("resizeScroll");f.trigger("sheetDeleteColumn",f.colLast)},sheetTab:function(m){var l="";if(m){l=f.obj.sheet().attr("title");l=(l?l:f.msg.sheetTitleDefault.replace(/[{]index[}]/gi,f.i+1))}else{if(f.isSheetEditable()&&k.editableNames){var n=prompt(f.msg.newSheetTitle,f.sheetTab(true));if(!n){l=f.obj.sheet().attr("title");n=(l?l:f.msg.sheetTitleDefault.replace(/[{]index[}]/gi,f.i+1))}else{f.setDirty(true);f.obj.sheet().attr("title",n);f.obj.tab().html(n);l=n}}}return d("<div />").text(l).html()},print:function(m){var l=window.open();l.document.write("<html><body><xmp>"+m+"\n</xmp></body></html>");l.document.close()},viewSource:function(m){var n=f.tables();n=f.sheetBarsRemove(n);var l="";if(m){d(n).each(function(){l+=f.HTMLtoPrettySource(this)})}else{l+=d("<div />").html(n).html()}f.print(l);return false},HTMLtoCompactSource:function(r){var m="";if(r.nodeType==1){m+="<"+r.tagName;p=false;var t=r.attributes.length;for(var q=0,p=false;q<t;q++){var o=r.attributes[q].name,s=r.getAttribute(o);if(s){if(o=="contentEditable"&&s=="inherit"){continue}if(o=="class"){p=true}if(typeof(s)=="string"){m+=" "+o+'="'+s.replace(/"/g,"'")+'"'}else{if(o=="style"&&s.cssText){m+=' style="'+s.cssText+'"'}}}}if(r.tagName=="COL"){m+="/>"}else{m+=">";var l="";d(r.childNodes).each(function(){l+=f.HTMLtoCompactSource(this)});m+=l;m+="</"+r.tagName+">"}}else{if(r.nodeType==3){m+=r.data.replace(/^\s*(.*)\s*$/g,"$1")}}return m},HTMLtoPrettySource:function(q,r){if(!r){r=""}var m="";if(q.nodeType==1){m+="\n"+r+"<"+q.tagName;var t=q.attributes.length;for(var p=0;p<t;p++){var o=q.attributes[p].name,s=q.getAttribute(o);if(s){if(o=="contentEditable"&&s=="inherit"){continue}if(typeof(s)=="string"){m+=" "+o+'="'+s.replace(/"/g,"'")+'"'}else{if(o=="style"&&s.cssText){m+=' style="'+s.cssText+'"'}}}}if(q.childNodes.length<=0){m+="/>"}else{m+=">";var l="",t=q.childNodes.length;for(var p=0;p<t;p++){l+=f.HTMLtoPrettySource(q.childNodes[p],r+"  ")}m+=l;if(l.indexOf("\n")>=0){m+="\n"+r}m+="</"+q.tagName+">"}}else{if(q.nodeType==3){m+=q.data.replace(/^\s*(.*)\s*$/g,"$1")}}return m},followMe:function(s,q){s=s||f.obj.cellActive();if(!s.length){return}var E=f.obj.pane(),n=E.offset(),v={top:n.top,bottom:n.top+E.height(),left:n.left,right:n.left+E.width()},F=true,H=0,u=0,t=0,G=5,l=s.offset(),D=s.width(),A=s.height(),B={top:l.top,bottom:l.top+A,left:l.left,right:l.left+D},r=s.parent(),C=d(f.rowTds()[f.getTdLocation(s).col]),z,p=0,J=0,m={up:true,down:true,left:true,right:true};if(!f.scrolledArea[f.i]){f.scrolledArea[f.i]={col:{start:f.frozenAt().col,end:f.frozenAt().col},row:{start:f.frozenAt().row,end:f.frozenAt().row}}}f.setBusy(true);while(F==true&&H<G){var o=f.getTd(f.i,f.scrolledArea[f.i].row.end+t,f.scrolledArea[f.i].col.end+u),w=C.is(":hidden"),I=r.is(":hidden");F=false;z={up:I,down:B.bottom-p>v.bottom,left:w,right:B.right-J>v.right};if(z.left){if(q){m.left=false}else{u--;F=true;f.evt.scroll.scrollTo({axis:"x",value:f.scrolledArea[f.i].col.end+u})}}else{if(z.right){if(q){m.right=false}else{u++;F=true}}}if(z.up){if(q){m.up=false}else{t--;F=true;f.evt.scroll.scrollTo({axis:"y",value:f.scrolledArea[f.i].row.end+t})}}else{if(z.down){if(q){m.down=false}else{t++;F=true}}}if(q){f.setBusy(false);return m}p+=o.height();J+=o.width();H++}if(u>0){f.evt.scroll.scrollTo({axis:"x",value:(f.scrolledArea[f.i].col.end+1)+u});f.evt.scroll.stop()}if(t>0){f.evt.scroll.scrollTo({axis:"y",value:(f.scrolledArea[f.i].row.end+1)+t});f.evt.scroll.stop()}setTimeout(function(){f.setBusy(false)},100);f.autoFillerGoToTd(s,A,D)},autoFillerGoToTd:function(o,m,n){if(!k.autoFiller){return}o=o||f.obj.cellActive();m=m||o.height();n=n||o.width();if(f.isTd(o[0])&&o.is(":visible")){var l=o.position();f.obj.autoFiller().show().css("top",((l.top+(m||o.height())-3)+"px")).css("left",((l.left+(n||o.width())-3)+"px"))}else{f.autoFillerHide()}},autoFillerHide:function(){if(!k.autoFiller){return}f.obj.autoFiller().hide()},setActiveSheet:function(l){l=l||0;if(f.cellLast.row>0||f.cellLast.col>0){f.evt.cellEditDone();f.obj.formula().val("")}f.obj.enclosures().hide();f.i=l;f.obj.enclosure().show();f.themeRoller.tab.setActive();f.readOnly[l]=f.obj.sheet().hasClass("readonly");f.obj.pane().trigger("resizeScroll")},openSheet:function(m){if(f.isDirty?confirm(f.msg.openSheet):true){f.setBusy(true);var o=f.controlFactory.header(),n=f.controlFactory.ui(),l=f.controlFactory.tabContainer();k.parent.append(o).append(n).append(l);m.each(function(p){f.controlFactory.sheetUI(d(this),p);f.calc(p);f.trigger("sheetOpened",[p])});f.sheetSyncSize();f.setActiveSheet(0);f.setDirty(false);f.setBusy(false);f.trigger("sheetAllOpened");return true}else{return false}},newSheet:function(){var l=prompt(f.msg.newSheet);if(l){f.openSheet(d.sheet.makeTable.fromSize(l))}},importRow:function(m){f.controlFactory.addRow();var l="";f.obj.sheet().find("tr:last td").each(function(n){d(this).removeData("formula");try{if((m[n]+"").charAt(0)=="="){d(this).data("formula",m[n])}else{d(this).html(m[n])}}catch(o){l+=o+";\n"}});if(l){alert(l)}f.calc()},importColumn:function(l){f.controlFactory.addColumn();var m="";f.obj.sheet().find("tr").each(function(n){var q=d(this).find("td:last");try{if((l[n]+"").charAt(0)=="="){q.data("formula",l[n])}else{q.html(l[n])}}catch(p){m+=p+";\n"}});if(m){alert(m)}f.calc()},sheetSyncSize:function(){var m=k.height;if(!m){m=400}else{if(m<200){m=200}}k.parent.height(m).width(k.width);var l=k.width;m-=f.obj.header().outerHeight();m-=f.obj.tabContainer().outerHeight()+f.s.boxModelCorrection;f.obj.panes().height(m-window.scrollBarSize.height-k.boxModelCorrection).width(l-window.scrollBarSize.width);f.obj.enclosures().height(m).width(l);f.obj.scrolls().height(m).width(l);f.obj.ui().height(m).width(l)},cellChangeStyle:function(l,m){f.setDirty(this);f.cellUndoable.add(f.obj.cellHighlighted());f.obj.cellHighlighted().css(l,m);f.cellUndoable.add(f.obj.cellHighlighted())},cellFind:function(m){if(!m){m=prompt(f.msg.cellFind)}var l=f.obj.sheet().children("tbody").children("tr");if(m){var n=l.children('td:contains("'+m+'")');if(n.length<1){n=l.children('td:contains("'+m.toLowerCase()+'")')}if(n.length<1){n=l.children('td:contains("'+m.toUpperCase()+'")')}n=n.eq(0);if(n.length>0){f.cellEdit(n)}else{alert(f.msg.cellNoFind)}}},cellSetActiveBar:function(t,m,p){var y=f.sheetSize(),r=Math.min(m,p),v=Math.max(m,p),x={},u={},s={},q={},l=function(){switch(k.cellSelectModel){case"oo":f.cellEdit(f.getTd(f.i,q.end,s.end));break;default:f.cellEdit(f.getTd(f.i,q.start,s.start));break}},o=d([]);switch(t){case"top":x.start=1;x.end=y.rows;q.start=q.end=f.scrolledArea[f.i].row.end;u.start=r;u.end=v;s.start=m;s.end=p;break;case"left":x.start=r;x.end=v;q.start=m;q.end=p;u.start=1;u.end=y.cols;s.start=s.end=f.scrolledArea[f.i].col.end;break;case"corner":u.start=1;u.end=y.cols;x.start=1;x.end=y.rows;break}for(var w=x.start;w<=x.end;w++){for(var n=u.start;n<=u.end;n++){o=o.add(f.getTd(f.i,w,n))}}l();f.themeRoller.cell.clearHighlighted();f.themeRoller.cell.setHighlighted(o);f.highlightedLast.td=o;f.highlightedLast.rowStart=x.start;f.highlightedLast.rowEnd=x.end;f.highlightedLast.colStart=u.start;f.highlightedLast.colEnd=u.end},getTdRange:function(o,t,r,s){f.cellLast.isEdit=true;var m=function(v){if(v.first.col>v.last.col||v.first.row>v.last.row){return{first:jSE.parseCellName(v.last.col,v.last.row),last:jSE.parseCellName(v.first.col,v.first.row)}}else{return{first:jSE.parseCellName(v.first.col,v.first.row),last:jSE.parseCellName(v.last.col,v.last.row)}}};var q=function(y){var v=m(y),x=t+"";x=(x.match(/=/)?x:"="+x);if(r||x.charAt(x.length-1)!="("){x=x+(r?r:"")+"("}var z,w="";if(v.first!=v.last){z=v.first+":"+v.last}else{z=v.first}if(x.charAt(x.length-1)=="("){w=")"}return x+z+w};var l="";if(o){var n={first:f.getTdLocation([o.target])};var p=f.obj.sheet().mousemove(function(v){n.last=f.getTdLocation([v.target]);l=q(n);if(!s){f.obj.formula().val(l);f.obj.inPlaceEdit().val(l)}});b.one("mouseup",function(){p.unbind("mousemove");return l})}else{var u=f.obj.cellHighlighted().not(f.obj.cellActive());if(u.length){var n={first:f.getTdLocation(u.first()),last:f.getTdLocation(u.last())};l=q(n);if(!s){f.obj.formula().val(l);f.obj.inPlaceEdit().val(l)}return l}else{return""}}},getTd:function(m,n,l){if(!f.spreadsheets[m]||!f.spreadsheets[m][n]||!f.spreadsheets[m][n][l]||!f.spreadsheets[m][n][l].td){return d("<td />")}return f.spreadsheets[m][n][l].td},getTdLocation:function(m){var l={col:0,row:0};m=m||"";if(!m&&!m[0]){return l}m=m[0]||m;if(m.cellIndex==j||m.parentNode==j||m.parentNode.rowIndex==j){return l}return{col:parseInt(m.cellIndex),row:parseInt(m.parentNode.rowIndex)}},getTdFromXY:function(o,n,l){var q=f.obj.pane(),m=q.offset();n+=m.top;o+=m.left;if((n>=m.top&&n<=m.top+q.height())&&(o>=m.left&&o<=m.left+q.width())){var p=d.nearest({x:o,y:n},f.obj.sheet().children("tbody").children("tr").children("td"));if(f.isTd(p)){return p}if(l&&f.isBar(p)){return p}return false}return false},getBarIndex:{left:function(l){l=l||{};if(!l.parentNode||isNaN(l.parentNode.rowIndex)){return -1}else{return l.parentNode.rowIndex}},top:function(l){l=l||{};if(isNaN(l.cellIndex)){return -1}else{return l.cellIndex}},corner:function(){return 0}},time:{now:new Date(),last:new Date(),diff:function(){return Math.abs(Math.ceil(this.last.getTime()-this.now.getTime())/1000).toFixed(5)},set:function(){this.last=this.now;this.now=new Date()},get:function(){return this.now.getHours()+":"+this.now.getMinutes()+":"+this.now.getSeconds()}},log:function(l){f.time.set();console.log(f.time.get()+", "+f.time.diff()+"; "+l)},changed:[],isChanged:function(){return f.changed[f.i]},setChanged:function(l){f.changed[f.i]=l},isDirty:false,setDirty:function(l){f.dirty=l},appendToFormula:function(l){var n=f.obj.formula(),m=n.val();if(m.charAt(0)!="="){m="="+m}n.val(m+l)},cellUndoable:{i:[],lastStack:[],stack:[],undoOrRedo:function(l){f.autoFillerHide();var n=0;if(!this.stack[f.i]){return}if(l&&this.i[f.i]>0){n=this.get(-1)}else{if(!l&&this.i[f.i]<this.stack[f.i].length){n=this.get(1)}}var m=this.stack[f.i][n];console.log(this.stack);for(var n in m){var p=m[n].td,o=f.getTdLocation(p);console.log(p);f.spreadsheets[f.i][o.row][o.col]=m[n];p.data("formula",m[n]["formula"]).attr("style",m[n]["style"]).attr("class",m[n]["class"]);f.cellLast.td=d([]);f.calcDependencies(f.i,o.row,o.col);f.cellEdit(p)}},pre:function(){if(!this.i[f.i]){this.i[f.i]=0}},group:function(){this.pre()},add:function(s,v,n,l){return;this.pre();var p=this.i[f.i]++;this.clean(true);var t=this.stack[f.i][p];var w={};var o=f.spreadsheets[s][v][n].td,q=f.getTdLocation(o);if(q.col>0&q.row>0){var u=f.spreadsheets[f.i][q.row][q.col];var m=f.i+"_"+q.row+"_"+q.col;if(!w[m]){w[m]={}}for(var r in u){w[m][r]=u[r]}w[m]["style"]=o.attr("style");w[m]["class"]=o.attr("class");w[m]["sheet"]=s}var p=this.get();this.stack[f.i][f.calcDependenciesLast]=cells;if(this.stack[f.i].length>p){for(var p=this.stack[f.i].length;this.stack[f.i].length<p;p--){this.stack[f.i].pop()}}if(this.stack[f.i].length>20){this.stack[f.i].shift()}},clean:function(l){this.i[f.i]}},cols:function(l){l=l||f.obj.sheet();if(!l[0]){return[]}if(!l[0].children){return[]}if(!l[0].children[0]){return[]}if(!l[0].children[0].children){return[]}return l[0].children[0].children},tables:function(l){l=l||f.obj.sheets();l=l.clone();l.find("."+f.cl.barTopParent).remove();l.find("."+f.cl.barLeft).remove();l.children("colgroup").children("col:first").remove();l=f.sheetDecorateRemove(false,l);return l},col:function(n,l){n=n||f.obj.sheet();var m=f.cols(n);if(l===j){l=m.length-1}return m[l]},rowTds:function(n,m){n=n||f.obj.sheet();var l=f.rows(n);if(m==j){m=l.length-1}if(!l[m]){return{}}if(!l[m].children){return{}}return l[m].children},rows:function(l){l=l||f.obj.sheet();if(!l[0]){return{}}if(!l[0].children){return{}}if(!l[0].children[1]){return{}}if(!l[0].children[1].children){return{}}return l[0].children[1].children},sheetSize:function(n){n=n||f.obj.sheet();var l=f.rowTds(n),m=f.getTdLocation(l[l.length-1]);return{cols:m.col,rows:m.row}},toggleState:function(l){if(k.allowToggleState){var m=l||f.tables().detach();if(k.editable){f.evt.cellEditAbandon();f.trigger("sheetSave",[m])}f.setDirty(false);f.setChanged(true);k.editable=!k.editable;f.kill();k.parent.html(m).sheet(k);k=null}},setCellRef:function(m){var o=f.obj.cellActive(),n=f.getTdLocation(o),l=(m?m:prompt(f.msg.setCellRef));if(l){f.s.formulaVariables[l]=f.updateCellValue(f.i,n.row,n.col)}}};f.setBusy(true);k.parent.data("sheetInstance",f);if(!window.console){window.console={log:function(){}}}if(!window.scrollBarSize){window.scrollBarSize=d.sheet.getScrollBarSize()}var a=d(window),b=d(document),c=d("body"),h=function(){},j=undefined;f.formulaLexer=function(){};f.formulaLexer.prototype=formula.lexer;f.formulaParser=function(){this.lexer=new f.formulaLexer();this.yy={}};f.formulaParser.prototype=formula;f.FormulaParser=new f.formulaParser;k.origHtml=k.parent.children().detach();k.parent.addClass(f.cl.parent);k.parent.unbind("sheetSwitch").bind("sheetSwitch",function(n,m,l){f.switchSheet(l)}).unbind("sheetRename").bind("sheetRename",function(n,m,l){f.renameSheet(l)});k.width=(k.width?k.width:k.parent.width());k.height=(k.height?k.height:k.parent.height());if(!k.log){f.log=h}if(!d.nearest){f.nearest=h}f.resizableCells=f.resizableSheet=f.resizable;if(!d.ui){f.resizable=f.draggable=h}else{if(!k.resizableCells){f.resizableCells=h}if(!k.resizableSheet){f.resizableSheet=h}}if(!d.support.boxModel){k.boxModelCorrection=0}if(!k.barMenus){f.controlFactory.barMenuTop=f.controlFactory.barMenuLeft=h}if(!k.freezableCells){f.controlFactory.barHandleFreeze.top=f.controlFactory.barHandleFreeze.left=h}if(k.calcOff){f.calc=h}if(!window.Raphael){jSE.chart=h}a.resize(function(){if(f&&!f.isBusy()){k.width=k.parent.width();k.height=k.parent.height();f.sheetSyncSize()}});if(d.sheet.fn){d.sheet.fn=d.extend(d.sheet.fn,k.formulaFunctions);if(d.sheet.advancedfn){d.sheet.fn=d.extend(d.sheet.fn,d.sheet.advancedfn)}if(d.sheet.financefn){d.sheet.fn=d.extend(d.sheet.fn,d.sheet.financefn)}}if(!k.alertFormulaErrors){f.alertFormulaError=h}k.title=k.title||k.parent.attr("title")||"";f.s=k;if(k.origHtml.length){f.openSheet(k.origHtml)}f.setBusy(false);return f},makeTable:{fromSize:function(c){c=c||{rows:25,cols:10};var d=jQuery("<table />");td="<td></td>",tds="";for(var b=c.cols;b>=1;b--){tds+=td}var f='<tr style="height: '+15+'px;">'+tds+"</tr>",a="";for(var b=c.rows;b>=1;b--){a+=f}return d.html("<tbody>"+a+"</tbody>")}},killAll:function(){if(jQuery.sheet){if(jQuery.sheet.instance){jQuery.sheet.instance.each(function(){if(this.kill){this.kill()}});jQuery.sheet.instance=$([])}}},scrollLocker:function(a){jQuery.sheet.instance[a].obj.scrolls().each(function(b){var c=this;$(this).bind("scroll",function(){jQuery.sheet.instance.each(function(d){if(d!=a){this.controls.scroll[b].scrollLeft(c.scrollLeft).scrollTop(c.scrollTop)}})})})},switchSheetLocker:function(a){jQuery.sheet.instance.each(function(){this.s.parent.bind("switch",function(d,c,b){jQuery.sheet.instance.each(function(){this.setActiveSheet(b)})})})},I:function(){var a=0;if(this.instance){a=(this.instance.length===0?0:this.instance.length-1)}else{this.instance=[]}return a},getScrollBarSize:function(){var c=$("<p></p>").css({width:"100%",height:"100%"}),g=$("<div></div>").css({position:"absolute",width:"100px",height:"100px",top:"0",left:"0",visibility:"hidden",overflow:"hidden"}).append(c);jQuery(document.body).append(g);var b=c.width(),f=c.height();g.css("overflow","scroll");var a=c.width(),d=c.height();if(b==a&&g[0].clientWidth){a=g[0].clientWidth}if(f==d&&g[0].clientHeight){d=g[0].clientHeight}g.detach();return{width:b-a,height:f-d}},debugPositionBox:function(a,g,c,b,f){b=b||"#"+Math.floor(Math.random()*16777215).toString(16);if(c){var d=jQuery([]);d=d.add(this.debugPositionBox(c.left,c.top,null,b,"top-left"));d=d.add(this.debugPositionBox(c.right,c.top,null,b,"top-right"));d=d.add(this.debugPositionBox(c.left,c.bottom,null,b,"bottom-left"));d=d.add(this.debugPositionBox(c.right,c.bottom,null,b,"bottom-right"));return d}return jQuery('<div style="width: 10px; height: 10px; position: absolute;"></div>').css("top",(g-5)+"px").css("left",(a+5)+"px").css("background-color",b).click(function(){console.log(f||"none")}).appendTo("body")}};var jSE=jQuery.sheet.engine={calc:function(b,d,f){for(var c=1;c<d.length;c++){for(var a=1;a<d[c].length;a++){f(b,c,a)}}},parseLocation:function(b){for(var a=0;a<b.length;a++){if(b.charCodeAt(a)<=57){break}}return{row:parseInt(b.substring(a)),col:jSE.columnLabelIndex(b.substring(0,a))}},parseSheetLocation:function(a){return((a+"").replace("SHEET","")*1)-1},parseCellName:function(a,b){return jSE.columnLabelString(a)+(b||"")},columnLabels:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",columnLabelIndex:function(c){var a=0,c=c.toUpperCase();for(var b=0;b<c.length;b++){var d=this.columnLabels.indexOf(c[b]);a=(a*26)+d}return(a>=0?a:0)+1},columnIndexes:[],columnLabelString:function(d){if(!this.columnIndexes.length){var g="",f,c,b,a;f=c=b=-1;for(a=1;a<16385;++a){g="";++b;if(b==26){b=0;++c;if(c==26){c=0;++f}}if(f>=0){g+=this.columnLabels[f]}if(c>=0){g+=this.columnLabels[c]}if(b>=0){g+=this.columnLabels[b]}this.columnIndexes[a]=g}}return this.columnIndexes[d]||""},regEx:{n:/[\$,\s]/g,cell:/\$?([a-zA-Z]+)\$?([0-9]+)/gi,range:/\$?([a-zA-Z]+)\$?([0-9]+):\$?([a-zA-Z]+)\$?([0-9]+)/gi,remoteCell:/\$?(SHEET+)\$?([0-9]+)[:!]\$?([a-zA-Z]+)\$?([0-9]+)/gi,remoteCellRange:/\$?(SHEET+)\$?([0-9]+)[:!]\$?([a-zA-Z]+)\$?([0-9]+):\$?([a-zA-Z]+)\$?([0-9]+)/gi,sheet:/SHEET/i,amp:/&/g,gt:/</g,lt:/>/g,nbsp:/&nbsp;/g},chart:function(d){var c=this.jS,a=this;function b(f,g){if(!f){if(g){f=0}else{f=""}}else{if(g){f=arrHelpers.toNumbers(f)}else{f=arrHelpers.flatten(f)}}return f}d=jQuery.extend({x:{legend:"",data:[0]},y:{legend:"",data:[0]},title:"",data:[0],legend:"",td:c.getTd(this.sheet,this.row,this.col),chart:jQuery('<div class="'+c.cl.chart+'" />').mousedown(function(){d.td.mousedown()}),gR:{}},d);c.controls.chart[c.i]=c.obj.chart().add(d.chart);d.data=b(d.data,true);d.x.data=b(d.x.data,true);d.y.data=b(d.y.data,true);d.legend=b(d.legend);d.x.legend=b(d.x.legend);d.y.legend=b(d.y.legend);d.legend=(d.legend?d.legend:d.data);this.s.parent.one("sheetCalculation",function(){var g=d.chart.width(),f=d.chart.height(),h=Raphael(d.chart[0]);if(d.title){h.text(g/2,10,d.title).attr({"font-size":20})}switch(d.type){case"bar":d.gR=h.barchart(g/8,f/8,g*0.8,f*0.8,d.data,d.legend).hover(function(){this.flag=h.popup(this.bar.x,this.bar.y,this.bar.value||"0").insertBefore(this)},function(){this.flag.animate({opacity:0},300,function(){this.remove()})});break;case"hbar":d.gR=h.hbarchart(g/8,f/8,g*0.8,f*0.8,d.data,d.legend).hover(function(){this.flag=h.popup(this.bar.x,this.bar.y,this.bar.value||"0").insertBefore(this)},function(){this.flag.animate({opacity:0},300,function(){this.remove()})});break;case"line":d.gR=h.linechart(g/8,f/8,g*0.8,f*0.8,d.x.data,d.y.data,{nostroke:false,axis:"0 0 1 1",symbol:"circle",smooth:true}).hoverColumn(function(){this.tags=h.set();if(this.symbols.length){for(var j=0,k=this.y.length;j<k;j++){this.tags.push(h.tag(this.x,this.y[j],this.values[j],160,10).insertBefore(this).attr([{fill:"#fff"},{fill:this.symbols[j].attr("fill")}]))}}},function(){this.tags&&this.tags.remove()});break;case"pie":d.gR=h.piechart(g/2,f/2,(g<f?g:f)/2,d.data,{legend:d.legend}).hover(function(){this.sector.stop();this.sector.scale(1.1,1.1,this.cx,this.cy);if(this.label){this.label[0].stop();this.label[0].attr({r:7.5});this.label[1].attr({"font-weight":800})}},function(){this.sector.animate({transform:"s1 1 "+this.cx+" "+this.cy},500,"bounce");if(this.label){this.label[0].animate({r:5},500,"bounce");this.label[1].attr({"font-weight":400})}});break;case"dot":d.gR=h.dotchart(g/8,f/8,g*0.8,f*0.8,d.x.data,d.y.data,d.data,{symbol:"o",max:10,heat:true,axis:"0 0 1 1",axisxstep:d.x.data.length-1,axisystep:d.y.data.length-1,axisxlabels:(d.x.legend?d.x.legend:d.x.data),axisylabels:(d.y.legend?d.y.legend:d.y.data),axisxtype:" ",axisytype:" "}).hover(function(){this.marker=this.marker||h.tag(this.x,this.y,this.value,0,this.r+2).insertBefore(this);this.marker.show()},function(){this.marker&&this.marker.hide()});break}d.gR.mousedown(function(){d.td.mousedown().mouseup()});d.chart.mousemove(function(){d.td.mousemove();return false})});return d.chart}};var jFN=jQuery.sheet.fn={ISNUMBER:function(a){if(!isNaN(a)){return jFN.TRUE()}return jFN.FALSE()},N:function(a){if(a==null){return 0}if(a instanceof Date){return a.getTime()}if(typeof(a)=="object"){a=a.toString()}if(typeof(a)=="string"){a=parseFloat(a.replace(jSE.regEx.n,""))}if(isNaN(a)){return 0}if(typeof(a)=="number"){return a}if(a==true){return 1}return 0},VERSION:function(){return this.jS.version},ABS:function(a){return Math.abs(jFN.N(a))},CEILING:function(b,a){a=a||1;return(parseInt(b/a)*a)+a},EVEN:function(a){a=Math.round(a);var b=(a%2==0);if(!b){if(a>0){a++}else{a--}}return a},EXP:function(a){return Math.exp(a)},FLOOR:function(b,a){a=a||1;if((b<0&&a>0)||(b>0&&a<0)){return{value:0,html:"#NUM"}}if(b>=0){return Math.floor(b/a)*a}else{return Math.ceil(b/a)*a}},INT:function(a){return Math.floor(jFN.N(a))},LN:function(a){return Math.log(a)},LOG:function(a,b){b=b||10;return Math.log(a)/Math.log(b)},LOG10:function(a){return jFN.LOG(a)},MOD:function(a,c){var b=a%c;if(c<0){b*=-1}return b},ODD:function(a){var c=false;if(a>0){a=Math.floor(Math.round(a));c=true}else{a=Math.ceil(a)}var b=Math.abs(a);if((b%2)==0){b++}if(c){return b}else{return -b}},PI:function(){return Math.PI},POWER:function(a,b){return Math.pow(a,b)},SQRT:function(a){return Math.sqrt(a)},RAND:function(){return Math.random()},RND:function(){return Math.random()},ROUND:function(b,a){return jFN.FIXED(b,(a?a:0),false)},ROUNDDOWN:function(b,a){var c=(b<0);b=Math.abs(b);a=a||0;b=Math.floor(b*Math.pow(10,a))/Math.pow(10,a);return(c?-b:b)},ROUNDUP:function(b,a){var c=(b<0);b=Math.abs(b);a=a||0;b=Math.ceil(b*Math.pow(10,a))/Math.pow(10,a);return(c?-b:b)},SUM:function(){var b=0,a=arrHelpers.toNumbers(arguments);for(i in a){b+=a[i]*1}return b},TRUNC:function(a,b){b=b||0;a=a+"";if(b==0){return a.split(".").shift()}if(a.match(".")){if(b==1){a=a.substr(0,a.length-1)}else{if(b==-1){a=a.split(".").shift();a=a.substr(0,a.length-1)+"0"}}}return a},AVERAGE:function(a){return jFN.SUM(arguments)/jFN.COUNT(arguments)},AVG:function(a){return jFN.AVERAGE(a)},COUNT:function(){var b=0,a=arrHelpers.toNumbers(arguments);for(i in a){if(a[i]!=null){b++}}return b},COUNTA:function(){var b=0,a=arrHelpers.flatten(arguments);for(i in a){if(a[i]){b++}}return b},MAX:function(){var b=arrHelpers.toNumbers(arguments),a=b[0];for(i in b){a=(b[i]>a?b[i]:a)}return a},MIN:function(){var a=arrHelpers.toNumbers(arguments),b=a[0];for(i in a){b=(a[i]<b?a[i]:b)}return b},ASC:function(a){return a.charCodeAt(0)},CHAR:function(a){return String.fromCharCode(a)},CLEAN:function(a){var b=new RegExp("[cG\x1BcLcJcMcIcK\x07\x1B\f\n\r\t\v]","g");return a.replace(b,"")},CODE:function(a){return jFN.ASC(a)},CONCATENATE:function(){var b=arrHelpers.flatten(arguments),a="";jQuery.each(b,function(c){a+=b[c]});return{value:a,html:a}},DOLLAR:function(b,a,f){if(a==null){a=2}if(f==null){f="$"}var d=jFN.FIXED(b,a,false),c;if(b>=0){c=f+d}else{c="-"+f+d.slice(1)}return{value:b,html:c}},FIXED:function(k,d,m){if(d==null){d=2}var j=Math.pow(10,d),c=String(Math.round(jFN.N(k)*j)/j),b=c.indexOf("."),a=(m?"":""),l=(m?"":",");if(b<0){b=c.length;c+="."}for(var f=c.length-b-1;f<d;f++){c+="0"}var h=c.replace("-","").split("."),o=[],g=true;while(h[0].length>0){if(!g){o.unshift(l)}o.unshift(h[0].slice(-3));h[0]=h[0].slice(0,-3);g=false}if(d>0){o.push(".");var g=true;while(h[1].length>0){if(!g){o.push(a)}o.push(h[1].slice(0,3));h[1]=h[1].slice(3);g=false}}if(k<0){return"-"+o.join("")}return o.join("")},LEFT:function(a,b){b=b||1;return a.substring(0,b)},LEN:function(a){if(!a){return 0}return a.length},LOWER:function(a){return a.toLowerCase()},MID:function(b,c,a){if(!b||!c||!a){return this.error({error:"ERROR"})}return b.substring(c-1,a+c-1)},REPLACE:function(b,f,c,d){if(!b||!f||!c||!d){return this.error({error:"ERROR"})}var a=b.split("");a.splice(f-1,c);a.splice(f-1,0,d);return a.join("")},REPT:function(b,d){var a="";for(var c=0;c<d;c++){a+=b}return a},RIGHT:function(a,b){b=b||1;return a.substring(a.length-b,a.length)},SEARCH:function(c,a,d){d=d||0;if(d){a=a.split("");a.splice(0,d-1);a=a.join("")}var b=a.search(c);if(b<0){return this.error({error:"#VALUE!"})}return d+(d?0:1)+b},SUBSTITUTE:function(d,a,c,f){f=f||0;a=new RegExp(a,"g");var b=1;d=d.replace(a,function(h,k,l,j){var g=h;if(f){if(b>=f){g=c}}else{g=c}b++;return g});return d},TEXT:function(){return this.error({error:"Not Yet Implemented"})},UPPER:function(a){return a.toUpperCase()},VALUE:function(a){if(jQuery.isNumeric(a)){return a*=1}else{return this.error({error:"#VALUE!"})}},NOW:function(){var a=new Date();return{value:a,html:dates.toString(a)}},TODAY:function(){var a=new Date();return{value:dates.toCentury(a)-1,html:dates.toString(a,"d")}},WEEKENDING:function(b){var a=new Date();a=new Date(a.getFullYear(),a.getMonth(),a.getDate()+5-a.getDay()-((b||0)*7));return{value:a,html:dates.toString(a,"d")}},WEEKDAY:function(b,c){b=dates.get(b);var a=b.getDay();c=(c?c:1);switch(c){case 3:switch(a){case 0:return 7;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;case 5:return 5;case 6:return 6}break;case 2:switch(a){case 0:return 6;case 1:return 0;case 2:return 1;case 3:return 2;case 4:return 3;case 5:return 4;case 6:return 5}break;case 1:a++;break}return a},WEEKNUM:function(a){a=dates.get(a);return dates.week(a)+1},YEAR:function(a){a=dates.get(a);return a.getFullYear()},DAYSFROM:function(b,c,a){return Math.floor((new Date()-new Date(b,(c-1),a))/dates.dayDiv)},DAYS:function(f,c){var b=dates.get(f),a=dates.get(c),d=1000*60*60*24;return Math.round(Math.abs(b.getTime()-a.getTime())/d)},DAY:function(a){a=dates.get(a);return a.getDate()},DAYS360:function(g,c,j){g=dates.get(g);c=dates.get(c);var a=g.getDate(),f=c.getDate(),d=dates.isLastDayOfMonth(g),h=dates.isLastDayOfMonth(c),b=dates.diffMonths(g,c);if(j){a=Math.min(a,30);f=Math.min(f,30)}else{if(d){a=30}if(h){if(a<30){b++;f=1}else{f=30}}}return(b*30)+(f-a)},DATE:function(c,d,a){var b=new Date(c,d-1,a);return{html:dates.toString(b,"d"),value:dates.toCentury(b)}},DATEVALUE:function(a){a=dates.get(a);return{html:dates.toString(a,"d"),value:dates.toCentury(a)}},EDATE:function(b,a){b=dates.get(b),b.setMonth(b.getMonth()+a);return{html:dates.toString(b,"d"),value:dates.toCentury(b)}},EOMONTH:function(b,a){b=dates.get(b),b.setMonth(b.getMonth()+a+1);b=new Date(b.getFullYear(),b.getMonth(),0);return{html:dates.toString(b,"d"),value:dates.toCentury(b)}},HOUR:function(a){return times.fromMath(a).hour},MINUTE:function(a){return times.fromMath(a).minute},MONTH:function(a){a=dates.get(a);return a.getMonth()+1},SECOND:function(a){return times.fromMath(a).second},TIME:function(a,h,c){var b=new Date();c=(c?c:0),h=(h?h:0),a=(a?a:0);if(c&&c>60){var d=(((c/60)+"").split(".")[0])*1;c=c-(d*60);h+=d}if(h&&h>60){var g=(((h/60)+"").split(".")[0])*1;h=h-(g*60);a+=g}var f=(a*60*60*1000)+(h*60*1000)+(c*1000);return f/dates.dayDiv},TIMEVALUE:function(a){if(!isNaN(a)){return a}if(/([0]?[1-9]|1[0-2])[:][0-5][0-9]([:][0-5][0-9])?[ ]?(AM|am|aM|Am|PM|pm|pM|Pm)/.test(a)){return times.fromString(a,true)}else{if(/([0]?[0-9]|1[0-9]|2[0-3])[:][0-5][0-9]([:][0-5][0-9])?/.test(a)){return times.fromString(a)}}return 0},WORKDAY:function(a,j,g){var d={1:true,2:true,3:true,4:true,5:true},a=dates.get(a),j=(j&&!isNaN(j)?j:0),c=0,b=0,h=new Date();h=a;if(g){if(!jQuery.isArray(g)){g=[g]}g=arrHelpers.flatten(g);var f={};jQuery.each(g,function(k){if(g[k]){f[dates.toString(dates.get(g[k]),"d")]=true}});g=f}else{g={}}while(b<j){h=new Date(h.setDate(h.getDate()+1));if(d[h.getDay()]){if(!g[dates.toString(h,"d")]){b++}}c++}return{html:dates.toString(h,"d"),value:dates.toCentury(h)}},YEARFRAC:function(a,f,d){a=dates.get(a);f=dates.get(f);if(!a||!f){return this.error({error:"#VALUE!"})}d=(d?d:0);var c=dates.diff(a,f,d),b=dates.calcAnnualBasis(a,f,d);return c/b},AND:function(){var a=arguments,b;jQuery.each(a,function(c){if(a[c]!==true&&b==undefined){b=jFN.FALSE()}});if(!b){b=jFN.TRUE()}return b},FALSE:function(){return{value:false,html:"FALSE"}},IF:function(f,c,a){var d,b;if(f){d=c;b=this.html[1]}else{d=a;b=this.html[2]}return{value:d,html:b}},NOT:function(a){if(a){return jFN.FALSE()}return jFN.TRUE()},OR:function(){var a=arguments,b;jQuery.each(a,function(c){if(a[c]===true&&b==undefined){b=jFN.TRUE()}});if(!b){b=jFN.FALSE()}return b},TRUE:function(){return{value:true,html:"TRUE"}},IMG:function(a){return{html:jQuery("<img />").attr("src",a)}},GETHTML:function(){return this.html[0]},TRIM:function(a){if(typeof(a)=="string"){a=jQuery.trim(a)}return a},HYPERLINK:function(b,a){a=(a?a:"LINK");return{html:jQuery('<a href="'+b+'" target="_new">'+a+"</a>")}},DROPDOWN:function(){var a=this.obj,f=this.jS,b=arrHelpers.flatten(arguments),d,g=f.getTdLocation(a.td);b=arrHelpers.unique(b);if(this.s.editable){var h="dropdown"+this.sheet+"_"+g.row+"_"+g.col+"_"+this.jS.I;d=jQuery('<select style="width: 100%;" name="'+h+'" id="'+h+'" />').mousedown(function(){f.cellEdit(jQuery(this).parent(),null,true)}).change(function(){a.value=jQuery(this).val();f.calcDependencies(a.sheet,g.row,g.col)});for(var c=0;c<(b.length<=50?b.length:50);c++){if(b[c]){d.append('<option value="'+b[c]+'">'+b[c]+"</option>")}}if(f.getTd(this.sheet,this.row,this.col).find("#"+h).length==0){a.value=f.spreadsheets[this.sheet][this.row][this.col].value}d.val(a.value)}return{value:a.value,html:d}},RADIO:function(){var a=this.obj,g=this.jS,c=arrHelpers.flatten(arguments),f,h=g.getTdLocation(a.td);c=arrHelpers.unique(c);if(this.s.editable){var j="radio"+this.sheet+"_"+h.row+"_"+h.col+"_"+this.jS.I;f=jQuery("<span />").mousedown(function(){g.cellEdit(jQuery(this).parent())});for(var d=0;d<(c.length<=25?c.length:25);d++){if(c[d]){var b=jQuery('<input type="radio" name="'+j+'" class="'+j+'" />').val(c[d]).change(function(){a.value=jQuery(this).val();g.calcDependencies(a.sheet,h.row,h.col)});if(c[d]==a.value){b.attr("checked","true")}f.append(b).append("<span>"+c[d]+"</span>").append("<br />")}}if(g.getTd(this.sheet,this.row,this.col).find("."+j).length==0){a.value=g.spreadsheets[this.sheet][this.row][this.col].value}}return{value:a.value,html:f}},CHECKBOX:function(j){if(jQuery.isArray(j)){j=j[0]}var k=this.obj,d=this.jS,c,g=d.getTdLocation(k.td);if(this.s.editable){var a="checkbox"+this.sheet+"_"+g.row+"_"+g.col+"_"+this.jS.I,f=jQuery('<input type="checkbox" name="'+a+'" class="'+a+'" />').val(j).change(function(){k.value=(jQuery(this).is(":checked")?jQuery(this).val():"");d.calcDependencies(k.sheet,g.row,g.col)});c=jQuery("<span />").append(f).append("<span>"+j+"</span><br />").mousedown(function(){d.cellEdit(jQuery(this).parent())});if(j==k.value){f.attr("checked",true)}var b=d.getTd(this.sheet,this.row,this.col);if(!b.children().length){if(b.html()==k.value){f.attr("checked",true)}}if(d.getTd(this.sheet,this.row,this.col).find("."+a).length==0){var h=d.spreadsheets[this.sheet][this.row][this.col].value;k.value=(h=="true"||h==true?j:"")}}return{value:k.value,html:c}},BARCHART:function(a,b,c){return{value:"",html:jSE.chart.apply(this,[{type:"bar",data:a,legend:b,title:c}])}},HBARCHART:function(a,b,c){return{value:"",html:jSE.chart.apply(this,[{type:"hbar",data:a,legend:b,title:c}])}},LINECHART:function(b,a){return{value:"",html:jSE.chart.apply(this,[{type:"line",x:{data:b},y:{data:a},title:""}])}},PIECHART:function(a,b,c){return{value:"",html:jSE.chart.apply(this,[{type:"pie",data:a,legend:b,title:c}])}},DOTCHART:function(g,d,a,c,b,f){return{value:"",html:jSE.chart.apply(this,[{type:"dot",data:(a?a:g),x:{data:g,legend:c},y:{data:(d?d:g),legend:(b?b:c)},title:f}])}},CELLREF:function(a){return(this.jS.spreadsheets[a]?this.jS.spreadsheets[a]:"Cell Reference Not Found")},CALCTIME:function(){var a=this;this.s.parent.one("sheetCalculation",function(){a.jS.getTd(a.sheet,a.row,a.col).text(a.jS.time.diff())});return""},HLOOKUP:function(g,f,d,a){var c=this.jS.cellLookup.apply(this);for(var b=0;b<f[0].length;b++){if(f[0][b]==g){return this.jS.updateCellValue(c[b].sheet,d-1,c[b].col)}}return a},VLOOKUP:function(g,f,d,a){var c=this.jS.cellLookup.apply(this);for(var b=0;b<f[0].length;b++){if(f[0][b]==g){return this.jS.updateCellValue(c[b].sheet,c[b].row,d)}}return a},THISROWCELL:function(a){if(isNaN(a)){a=jSE.columnLabelIndex(a)}return this.jS.updateCellValue(this.sheet,this.row,a)},THISCOLCELL:function(a){return this.jS.updateCellValue(this.sheet,a,this.col)}};var key={BACKSPACE:8,CAPS_LOCK:20,COMMA:188,CONTROL:17,ALT:18,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,INSERT:45,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SHIFT:16,SPACE:32,TAB:9,UP:38,C:67,F:70,V:86,X:88,Y:89,Z:90};var arrHelpers={toNumbers:function(a){a=this.flatten(a);for(i in a){if(a[i]){a[i]=jQuery.trim(a[i]);if(isNaN(a[i])){a[i]=0}else{a[i]=a[i]*1}}else{a[i]=0}}return a},unique:function(b){var d=[],c=b.length;for(var g=0;g<c;g++){for(var f=g+1;f<c;f++){if(b[g]===b[f]){f=++g}}d.push(b[g])}return d},flatten:function(a){var f=[];for(var c=0,b=a.length;c<b;c++){var d=Object.prototype.toString.call(a[c]).split(" ").pop().split("]").shift().toLowerCase();if(d){f=f.concat(/^(array|collection|arguments|object)$/.test(d)?this.flatten(a[c]):a[c])}}return f},insertAt:function(a,c,b){jQuery(c).each(function(){if(b>-1&&b<=a.length){a.splice(b,0,this)}});return a},getClosestValues:function(c,b){var f=null;c=c||[];b=b||0;for(var d=0;d<c.length;d++){if(f==null||Math.abs(c[d]-b)<=Math.abs(f-b)){f=c[d]}}return f}};var dates={dayDiv:86400000,toCentury:function(a){return Math.round(Math.abs((new Date(1900,0,-1))-a)/this.dayDiv)},get:function(b){if(b.getMonth){return b}else{if(isNaN(b)){return new Date(Globalize.parseDate(b))}else{b*=this.dayDiv;var a=(new Date(1900,0,-1))*1;b+=a;b=new Date(b);return b}}},week:function(a){var b=new Date(a.getFullYear(),0,1);return Math.ceil((((a-b)/this.dayDiv)+b.getDay()+1)/7)},toString:function(a,b){if(!b){return Globalize.format(a)}return Globalize.format(a,Globalize.culture().calendar.patterns[b])},diff:function(d,b,c){switch(c){case 0:return this.days360Nasd(d,b,0,true);case 1:case 2:case 3:var a=Math.abs(b-d)/this.dayDiv;return a;case 4:return this.days360Euro(d,b)}},diffMonths:function(c,b){var a;a=(b.getFullYear()-c.getFullYear())*12;a-=c.getMonth()+1;a+=b.getMonth()+1;return a},days360:function(c,g,d,b,a,f){return((g-c)*360)+((b-d)*30)+(f-a)},days360Nasd:function(b,f,a,c){var d=b.getDate(),k=b.getMonth(),j=b.getFullYear(),h=f.getDate(),g=f.getMonth(),l=f.getFullYear();if((g==2&&this.isEndOfMonth(h,g,l))&&((k==2&&this.isEndOfMonth(d,k,j))||a==3)){h=30}if(h==31&&(d>=30||a==3)){h=30}if(d==31){d=30}if(c&&k==2&&this.isEndOfMonth(d,k,j)){d=30}return this.days360(j,l,k,g,d,h)},days360Euro:function(j,c){var a=j.getDate(),f=j.getMonth(),d=j.getFullYear(),g=c.getDate(),b=c.getMonth(),h=c.getFullYear();if(a==31){a=30}if(g==31){g=30}return this.days360(d,h,f,b,a,g)},isEndOfMonth:function(a,c,b){return a==(new Date(b,c+1,0,23,59,59)).getDate()},isLeapYear:function(a){return new Date(a,1,29).getMonth()==1},calcAnnualBasis:function(a,c,h){switch(h){case 0:case 2:case 4:return 360;case 3:return 365;case 1:var b=a.getDate(),k=a.getMonth(),g=a.getFullYear(),d=c.getDate(),f=c.getMonth(),l=c.getFullYear(),m;if(g==l){if(this.isLeapYear(g)){m=366}else{m=365}}else{if(((l-1)==g)&&((k>f)||((k==f)&&b>=d))){if(this.isLeapYear(g)){if(k<2||(k==2&&b<=29)){m=366}else{m=365}}else{if(this.isLeapYear(l)){if(f>2||(f==2&&d==29)){m=366}else{m=365}}else{m=365}}}else{for(var j=g;j<=l;j++){if(this.isLeapYear(j)){m+=366}else{m+=365}}m=m/(l-g+1)}}return m}},lastDayOfMonth:function(a){a.setDate(0);return a.getDate()},isLastDayOfMonth:function(a){return(a.getDate()==this.lastDayOfMonth(a))}};var times={fromMath:function(b){var a={};a.hour=((b*24)+"").split(".")[0];a.minute=function(c){c=Math.round(c*24*100)/100;c=(c+"").split(".");var d=0;if(c[1]){if(c[1].length<2){c[1]+="0"}d=c[1]*0.6}return Math.round(d)}(b);a.second=function(g){g=Math.round(g*24*10000)/10000;g=(g+"").split(".");var d=0;if(g[1]){for(var f=0;f<4;f++){if(!g[1].charAt(f)){g[1]+="0"}}var c=((g[1]*0.006)+"").split(".");if(c[1]){if(c[1]&&c[1].length>2){c[1]=c[1].substr(0,2)}return Math.round(c[1]*0.6)}}return d}(b);return a},fromString:function(c,j){var d=new Date(),h=c,a,g,f,b,k;if(j){k=h.substr(-2).toLowerCase();h=h.replace(/(am|pm)/i,"")}h=h.split(":");g=h[0]*1;f=h[1]*1;b=(h[2]?h[2]:0)*1;if(j&&k=="pm"){g+=12}return jFN.TIME(g,f,b)}};var math={log10:function(a){return Math.log(a)/2.302585092994046},signum:function(a){return(a/Math.abs(a))||a}};